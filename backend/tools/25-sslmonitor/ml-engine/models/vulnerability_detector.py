"""
Vulnerability Detector - SSL/TLS vulnerability detection
"""

from typing import Dict, Any, List


class VulnerabilityDetector:
    """Detect SSL/TLS vulnerabilities"""
    
    def __init__(self):
        self.known_vulnerabilities = {
            'heartbleed': {
                'name': 'Heartbleed',
                'cve': 'CVE-2014-0160',
                'severity': 'critical',
                'description': 'OpenSSL TLS heartbeat extension vulnerability',
                'affected': ['OpenSSL 1.0.1 - 1.0.1f']
            },
            'poodle': {
                'name': 'POODLE',
                'cve': 'CVE-2014-3566',
                'severity': 'high',
                'description': 'Padding Oracle On Downgraded Legacy Encryption',
                'affected': ['SSLv3']
            },
            'beast': {
                'name': 'BEAST',
                'cve': 'CVE-2011-3389',
                'severity': 'medium',
                'description': 'Browser Exploit Against SSL/TLS',
                'affected': ['TLSv1.0 with CBC ciphers']
            },
            'freak': {
                'name': 'FREAK',
                'cve': 'CVE-2015-0204',
                'severity': 'high',
                'description': 'Factoring RSA Export Keys',
                'affected': ['Export cipher suites']
            },
            'logjam': {
                'name': 'Logjam',
                'cve': 'CVE-2015-4000',
                'severity': 'high',
                'description': 'Diffie-Hellman key exchange weakness',
                'affected': ['DH export ciphers', 'DH < 1024 bits']
            },
            'drown': {
                'name': 'DROWN',
                'cve': 'CVE-2016-0800',
                'severity': 'critical',
                'description': 'Decrypting RSA with Obsolete and Weakened eNcryption',
                'affected': ['SSLv2']
            },
            'robot': {
                'name': 'ROBOT',
                'cve': 'CVE-2017-13099',
                'severity': 'high',
                'description': 'Return Of Bleichenbacher\'s Oracle Threat',
                'affected': ['RSA encryption']
            },
            'sweet32': {
                'name': 'Sweet32',
                'cve': 'CVE-2016-2183',
                'severity': 'medium',
                'description': 'Birthday attack on 64-bit block ciphers',
                'affected': ['3DES', 'Blowfish']
            },
            'lucky13': {
                'name': 'Lucky13',
                'cve': 'CVE-2013-0169',
                'severity': 'medium',
                'description': 'Timing attack on CBC mode',
                'affected': ['CBC ciphers']
            }
        }
        
        self.deprecated_protocols = ['SSLv2', 'SSLv3', 'TLSv1', 'TLSv1.0', 'TLSv1.1']
        self.weak_ciphers = [
            'NULL', 'EXPORT', 'anon', 'DES', 'RC4', 'RC2', 'MD5'
        ]
    
    def detect(self, scan_data: Dict[str, Any]) -> Dict[str, Any]:
        """Detect vulnerabilities from scan data"""
        vulnerabilities = []
        warnings = []
        
        protocols = scan_data.get('protocols', [])
        ciphers = scan_data.get('ciphers', [])
        
        # Protocol-based vulnerabilities
        protocol_vulns = self._check_protocol_vulnerabilities(protocols)
        vulnerabilities.extend(protocol_vulns)
        
        # Cipher-based vulnerabilities
        cipher_vulns = self._check_cipher_vulnerabilities(ciphers)
        vulnerabilities.extend(cipher_vulns)
        
        # Check for deprecated protocols
        deprecated = self._check_deprecated_protocols(protocols)
        warnings.extend(deprecated)
        
        # Check for weak ciphers
        weak = self._check_weak_ciphers(ciphers)
        warnings.extend(weak)
        
        return {
            'hostname': scan_data.get('hostname'),
            'vulnerabilities': vulnerabilities,
            'warnings': warnings,
            'vulnerability_count': len(vulnerabilities),
            'warning_count': len(warnings),
            'risk_level': self._calculate_risk_level(vulnerabilities, warnings)
        }
    
    def _check_protocol_vulnerabilities(self, protocols: List) -> List[Dict[str, Any]]:
        """Check for protocol-related vulnerabilities"""
        vulns = []
        
        protocol_names = []
        for p in protocols:
            if isinstance(p, dict):
                name = p.get('name', '') or p.get('version', '')
            else:
                name = str(p)
            protocol_names.append(name.upper())
        
        # Check SSLv2 (DROWN)
        if any('SSLV2' in p for p in protocol_names):
            vulns.append({
                **self.known_vulnerabilities['drown'],
                'detected': True
            })
        
        # Check SSLv3 (POODLE)
        if any('SSLV3' in p for p in protocol_names):
            vulns.append({
                **self.known_vulnerabilities['poodle'],
                'detected': True
            })
        
        # Check TLSv1.0 (BEAST potential)
        if any('TLSV1.0' in p or p == 'TLSV1' for p in protocol_names):
            vulns.append({
                **self.known_vulnerabilities['beast'],
                'detected': True,
                'note': 'May be vulnerable if CBC ciphers are used'
            })
        
        return vulns
    
    def _check_cipher_vulnerabilities(self, ciphers: List) -> List[Dict[str, Any]]:
        """Check for cipher-related vulnerabilities"""
        vulns = []
        
        cipher_names = []
        for c in ciphers:
            if isinstance(c, dict):
                name = c.get('name', '')
            else:
                name = str(c)
            cipher_names.append(name.upper())
        
        # Check EXPORT ciphers (FREAK)
        if any('EXPORT' in c for c in cipher_names):
            vulns.append({
                **self.known_vulnerabilities['freak'],
                'detected': True
            })
        
        # Check DH export (Logjam)
        if any('DHE_EXPORT' in c or 'DH_EXPORT' in c for c in cipher_names):
            vulns.append({
                **self.known_vulnerabilities['logjam'],
                'detected': True
            })
        
        # Check 3DES (Sweet32)
        if any('3DES' in c or 'DES-CBC3' in c for c in cipher_names):
            vulns.append({
                **self.known_vulnerabilities['sweet32'],
                'detected': True
            })
        
        # Check CBC ciphers (Lucky13)
        if any('CBC' in c for c in cipher_names):
            vulns.append({
                **self.known_vulnerabilities['lucky13'],
                'detected': True,
                'note': 'Consider using AEAD ciphers instead'
            })
        
        return vulns
    
    def _check_deprecated_protocols(self, protocols: List) -> List[Dict[str, Any]]:
        """Check for deprecated protocols"""
        warnings = []
        
        for p in protocols:
            if isinstance(p, dict):
                name = p.get('name', '') or p.get('version', '')
                supported = p.get('supported', True)
            else:
                name = str(p)
                supported = True
            
            if supported:
                for deprecated in self.deprecated_protocols:
                    if deprecated.upper() in name.upper():
                        warnings.append({
                            'type': 'deprecated_protocol',
                            'protocol': name,
                            'description': f'{name} is deprecated and should be disabled',
                            'recommendation': 'Disable this protocol and use TLS 1.2 or 1.3'
                        })
                        break
        
        return warnings
    
    def _check_weak_ciphers(self, ciphers: List) -> List[Dict[str, Any]]:
        """Check for weak cipher suites"""
        warnings = []
        
        for c in ciphers:
            if isinstance(c, dict):
                name = c.get('name', '')
                secure = c.get('secure', True)
            else:
                name = str(c)
                secure = True
            
            is_weak = not secure or any(w in name.upper() for w in self.weak_ciphers)
            
            if is_weak:
                warnings.append({
                    'type': 'weak_cipher',
                    'cipher': name,
                    'description': f'{name} is considered weak',
                    'recommendation': 'Remove this cipher suite'
                })
        
        return warnings
    
    def analyze_protocols(self, protocols: List) -> Dict[str, Any]:
        """Analyze protocol support"""
        analysis = {
            'supported': [],
            'deprecated': [],
            'modern': False,
            'legacy': False,
            'recommendations': []
        }
        
        for p in protocols:
            if isinstance(p, str):
                name = p
            else:
                name = p.get('name', '') or p.get('version', '')
            
            analysis['supported'].append(name)
            
            if name.upper() in ['TLSV1.3', 'TLSV1.2']:
                analysis['modern'] = True
            elif any(d.upper() in name.upper() for d in self.deprecated_protocols):
                analysis['deprecated'].append(name)
                analysis['legacy'] = True
        
        if analysis['legacy']:
            analysis['recommendations'].append('Disable all deprecated protocols')
        if not analysis['modern']:
            analysis['recommendations'].append('Enable TLS 1.2 and TLS 1.3')
        
        return analysis
    
    def analyze_ciphers(self, ciphers: List) -> Dict[str, Any]:
        """Analyze cipher suite support"""
        analysis = {
            'total': len(ciphers),
            'secure': 0,
            'weak': 0,
            'weak_ciphers': [],
            'recommendations': []
        }
        
        for c in ciphers:
            if isinstance(c, str):
                name = c
            else:
                name = c.get('name', '')
            
            is_weak = any(w in name.upper() for w in self.weak_ciphers)
            
            if is_weak:
                analysis['weak'] += 1
                analysis['weak_ciphers'].append(name)
            else:
                analysis['secure'] += 1
        
        if analysis['weak'] > 0:
            analysis['recommendations'].append(
                f"Remove {analysis['weak']} weak cipher suite(s)"
            )
        
        return analysis
    
    def _calculate_risk_level(self, vulnerabilities: List, warnings: List) -> str:
        """Calculate overall risk level"""
        critical = sum(1 for v in vulnerabilities if v.get('severity') == 'critical')
        high = sum(1 for v in vulnerabilities if v.get('severity') == 'high')
        
        if critical > 0:
            return 'critical'
        elif high > 0:
            return 'high'
        elif len(vulnerabilities) > 0:
            return 'medium'
        elif len(warnings) > 2:
            return 'low'
        return 'minimal'
    
    def get_known_vulnerabilities(self) -> List[Dict[str, Any]]:
        """Get list of known vulnerabilities"""
        return [
            {
                'id': key,
                'name': vuln['name'],
                'cve': vuln['cve'],
                'severity': vuln['severity'],
                'description': vuln['description']
            }
            for key, vuln in self.known_vulnerabilities.items()
        ]
