const mongoose = require('mongoose');

const vulnerabilitySchema = new mongoose.Schema({
  // Reference
  endpointId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'APIEndpoint',
    index: true
  },
  scanId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'APIScan',
    index: true
  },
  specId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'APISpec',
    index: true
  },

  // Vulnerability Details
  type: {
    type: String,
    required: true,
    enum: [
      // OWASP API Top 10 2023
      'BOLA',           // Broken Object Level Authorization
      'BROKEN_AUTH',    // Broken Authentication
      'BOPLA',          // Broken Object Property Level Authorization
      'UNRESTRICTED_RESOURCE', // Unrestricted Resource Consumption
      'BFLA',           // Broken Function Level Authorization
      'MASS_ASSIGNMENT', // Unrestricted Access to Sensitive Business Flows
      'SSRF',           // Server Side Request Forgery
      'SECURITY_MISCONFIG', // Security Misconfiguration
      'IMPROPER_ASSET_MGMT', // Improper Inventory Management
      'UNSAFE_API_CONSUMPTION', // Unsafe Consumption of APIs
      
      // Injection Types
      'SQL_INJECTION',
      'NOSQL_INJECTION',
      'COMMAND_INJECTION',
      'LDAP_INJECTION',
      'XPATH_INJECTION',
      'XXE',
      'XSS',
      
      // Auth & Session
      'JWT_VULNERABILITY',
      'SESSION_FIXATION',
      'INSECURE_TOKEN',
      'WEAK_PASSWORD_POLICY',
      'BRUTE_FORCE_POSSIBLE',
      
      // Data Exposure
      'SENSITIVE_DATA_EXPOSURE',
      'PII_EXPOSURE',
      'VERBOSE_ERROR',
      'DEBUG_ENABLED',
      'INFORMATION_DISCLOSURE',
      
      // Rate & Resource
      'NO_RATE_LIMITING',
      'DOS_VULNERABLE',
      'RESOURCE_EXHAUSTION',
      
      // Other
      'CORS_MISCONFIGURATION',
      'INSECURE_TRANSPORT',
      'MISSING_SECURITY_HEADERS',
      'OPEN_REDIRECT',
      'FILE_UPLOAD_VULNERABILITY',
      'OTHER'
    ]
  },
  category: {
    type: String,
    enum: ['injection', 'auth', 'data-exposure', 'rate-limiting', 'config', 'business-logic', 'other']
  },
  
  // Severity & Scoring
  severity: {
    type: String,
    enum: ['critical', 'high', 'medium', 'low', 'info'],
    required: true
  },
  cvssScore: {
    type: Number,
    min: 0,
    max: 10
  },
  cvssVector: String,
  
  // CWE & OWASP Mapping
  cweId: String,
  cweName: String,
  owaspCategory: String,
  owaspRank: Number,

  // Description
  title: {
    type: String,
    required: true
  },
  description: String,
  technicalDetails: String,
  
  // Evidence
  evidence: {
    request: {
      method: String,
      url: String,
      headers: mongoose.Schema.Types.Mixed,
      body: mongoose.Schema.Types.Mixed
    },
    response: {
      statusCode: Number,
      headers: mongoose.Schema.Types.Mixed,
      body: String,
      responseTime: Number
    },
    payload: String,
    matchedPattern: String,
    screenshot: String
  },

  // Remediation
  recommendation: String,
  remediationCode: {
    language: String,
    code: String
  },
  references: [String],

  // Status
  status: {
    type: String,
    enum: ['open', 'confirmed', 'false-positive', 'fixed', 'accepted', 'in-progress'],
    default: 'open'
  },
  confirmedAt: Date,
  confirmedBy: String,
  fixedAt: Date,
  
  // Exploitation
  exploitability: {
    type: String,
    enum: ['easy', 'moderate', 'difficult', 'theoretical']
  },
  exploitAvailable: {
    type: Boolean,
    default: false
  },
  exploitCode: String,

  // Impact
  impact: {
    confidentiality: { type: String, enum: ['none', 'low', 'high'] },
    integrity: { type: String, enum: ['none', 'low', 'high'] },
    availability: { type: String, enum: ['none', 'low', 'high'] }
  },
  affectedData: [String],
  businessImpact: String

}, {
  timestamps: true
});

// Indexes
vulnerabilitySchema.index({ severity: 1, status: 1 });
vulnerabilitySchema.index({ type: 1 });
vulnerabilitySchema.index({ cweId: 1 });

// Virtual for OWASP API category name
vulnerabilitySchema.virtual('owaspName').get(function() {
  const owaspMap = {
    'BOLA': 'API1:2023 Broken Object Level Authorization',
    'BROKEN_AUTH': 'API2:2023 Broken Authentication',
    'BOPLA': 'API3:2023 Broken Object Property Level Authorization',
    'UNRESTRICTED_RESOURCE': 'API4:2023 Unrestricted Resource Consumption',
    'BFLA': 'API5:2023 Broken Function Level Authorization',
    'MASS_ASSIGNMENT': 'API6:2023 Unrestricted Access to Sensitive Business Flows',
    'SSRF': 'API7:2023 Server Side Request Forgery',
    'SECURITY_MISCONFIG': 'API8:2023 Security Misconfiguration',
    'IMPROPER_ASSET_MGMT': 'API9:2023 Improper Inventory Management',
    'UNSAFE_API_CONSUMPTION': 'API10:2023 Unsafe Consumption of APIs'
  };
  return owaspMap[this.type] || this.type;
});

module.exports = mongoose.model('APIVulnerability', vulnerabilitySchema);
