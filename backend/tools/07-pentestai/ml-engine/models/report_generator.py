"""
PenTestAI ML Engine - Report Generator Model
AI-powered penetration test report generation
"""

import numpy as np
import logging
from typing import Dict, Any, List
from datetime import datetime

logger = logging.getLogger(__name__)


class ReportGenerator:
    """
    AI-powered report generation for penetration tests.
    """
    
    def __init__(self):
        self.version = "1.0.0"
        self.is_loaded = True
        
        logger.info(f"Report Generator v{self.version} loaded")
    
    def generate(
        self, 
        test_id: str, 
        findings: List[Dict[str, Any]], 
        target: Dict[str, Any]
    ) -> Dict[str, Any]:
        """Generate comprehensive pentest report"""
        
        # Analyze findings
        findings_summary = self._summarize_findings(findings)
        
        # Generate executive summary
        executive_summary = self._generate_executive_summary(findings_summary, target)
        
        # Process detailed findings
        detailed_findings = self._process_detailed_findings(findings)
        
        # Generate recommendations
        recommendations = self._generate_recommendations(findings)
        
        # Calculate risk rating
        risk_rating = self._calculate_risk_rating(findings_summary)
        
        return {
            "executive_summary": executive_summary,
            "findings_summary": findings_summary,
            "detailed_findings": detailed_findings,
            "recommendations": recommendations,
            "risk_rating": risk_rating
        }
    
    def _summarize_findings(self, findings: List[Dict[str, Any]]) -> Dict[str, Any]:
        """Summarize all findings"""
        
        summary = {
            "total": len(findings),
            "by_severity": {
                "CRITICAL": 0,
                "HIGH": 0,
                "MEDIUM": 0,
                "LOW": 0,
                "INFO": 0
            },
            "by_category": {},
            "exploited": 0,
            "false_positives": 0
        }
        
        for finding in findings:
            severity = finding.get("severity", "MEDIUM")
            category = finding.get("category", "Other")
            
            if severity in summary["by_severity"]:
                summary["by_severity"][severity] += 1
            
            if category not in summary["by_category"]:
                summary["by_category"][category] = 0
            summary["by_category"][category] += 1
            
            if finding.get("exploitation", {}).get("successful"):
                summary["exploited"] += 1
            
            if finding.get("status") == "false_positive":
                summary["false_positives"] += 1
        
        return summary
    
    def _generate_executive_summary(
        self, 
        summary: Dict[str, Any], 
        target: Dict[str, Any]
    ) -> str:
        """Generate executive summary text"""
        
        target_name = target.get("host", "the target system")
        target_type = target.get("target_type", "system")
        total = summary["total"]
        critical = summary["by_severity"]["CRITICAL"]
        high = summary["by_severity"]["HIGH"]
        
        # Generate summary text
        risk_level = "CRITICAL" if critical > 0 else "HIGH" if high > 0 else "MODERATE"
        
        text = f"""A comprehensive penetration test was conducted against {target_name} ({target_type}). 

The assessment identified a total of {total} security findings. Of these, {critical} are rated as Critical severity and {high} as High severity, indicating a {risk_level} overall risk level.

"""
        
        if critical > 0:
            text += "CRITICAL findings require immediate attention as they pose significant risk of compromise. "
        
        if high > 0:
            text += "HIGH severity findings should be addressed within the next 30 days. "
        
        if summary["exploited"] > 0:
            text += f"\n\n{summary['exploited']} vulnerabilities were successfully exploited during testing, demonstrating real-world attack feasibility. "
        
        text += "\n\nDetailed findings and remediation recommendations are provided in the sections below."
        
        return text
    
    def _process_detailed_findings(self, findings: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
        """Process findings for detailed reporting"""
        
        detailed = []
        
        # Sort by severity
        severity_order = {"CRITICAL": 0, "HIGH": 1, "MEDIUM": 2, "LOW": 3, "INFO": 4}
        sorted_findings = sorted(
            findings, 
            key=lambda x: severity_order.get(x.get("severity", "INFO"), 5)
        )
        
        for finding in sorted_findings:
            detailed.append({
                "id": finding.get("vuln_id", finding.get("id", "")),
                "title": finding.get("title", "Untitled Finding"),
                "severity": finding.get("severity", "MEDIUM"),
                "description": finding.get("description", ""),
                "impact": self._generate_impact(finding),
                "technical_details": finding.get("technical_details", {}),
                "proof_of_concept": finding.get("exploitation", {}).get("proof_of_concept", ""),
                "remediation": finding.get("remediation", {}),
                "references": self._get_references(finding)
            })
        
        return detailed
    
    def _generate_impact(self, finding: Dict[str, Any]) -> str:
        """Generate impact description"""
        
        severity = finding.get("severity", "MEDIUM")
        category = finding.get("category", "vulnerability")
        
        impact_templates = {
            "CRITICAL": "This vulnerability could allow an attacker to gain full control of the affected system, potentially leading to complete data breach, service disruption, or further lateral movement within the network.",
            "HIGH": "Exploitation of this vulnerability could result in significant unauthorized access, data exposure, or service impact requiring immediate remediation.",
            "MEDIUM": "This finding represents a security weakness that could be leveraged in combination with other vulnerabilities to escalate an attack.",
            "LOW": "While this finding poses limited direct risk, it provides information that could assist attackers in planning more sophisticated attacks."
        }
        
        return impact_templates.get(severity, impact_templates["MEDIUM"])
    
    def _generate_recommendations(self, findings: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
        """Generate prioritized recommendations"""
        
        recommendations = []
        seen_categories = set()
        
        # Sort by severity
        severity_order = {"CRITICAL": 0, "HIGH": 1, "MEDIUM": 2, "LOW": 3, "INFO": 4}
        sorted_findings = sorted(
            findings, 
            key=lambda x: severity_order.get(x.get("severity", "INFO"), 5)
        )
        
        for finding in sorted_findings[:10]:  # Top 10 recommendations
            category = finding.get("category", "general")
            
            if category in seen_categories:
                continue
            seen_categories.add(category)
            
            remediation = finding.get("remediation", {})
            
            recommendations.append({
                "priority": finding.get("severity", "MEDIUM"),
                "category": category,
                "title": f"Address {category} vulnerabilities",
                "description": remediation.get("description", f"Remediate {category} issues"),
                "steps": remediation.get("steps", [f"Review and fix {category} findings"]),
                "effort": remediation.get("effort", "Medium"),
                "affected_findings": 1
            })
        
        return recommendations
    
    def _calculate_risk_rating(self, summary: Dict[str, Any]) -> str:
        """Calculate overall risk rating"""
        
        critical = summary["by_severity"]["CRITICAL"]
        high = summary["by_severity"]["HIGH"]
        medium = summary["by_severity"]["MEDIUM"]
        
        score = critical * 10 + high * 5 + medium * 2
        
        if score >= 30 or critical >= 2:
            return "CRITICAL"
        elif score >= 15 or critical >= 1 or high >= 3:
            return "HIGH"
        elif score >= 5 or high >= 1:
            return "MEDIUM"
        else:
            return "LOW"
    
    def _get_references(self, finding: Dict[str, Any]) -> List[str]:
        """Get reference links for finding"""
        
        refs = []
        
        cve_id = finding.get("cve_id") or finding.get("cveId")
        cwe_id = finding.get("cwe_id") or finding.get("cweId")
        
        if cve_id:
            refs.append(f"https://nvd.nist.gov/vuln/detail/{cve_id}")
        
        if cwe_id:
            refs.append(f"https://cwe.mitre.org/data/definitions/{cwe_id.replace('CWE-', '')}.html")
        
        refs.append("https://owasp.org/www-project-web-security-testing-guide/")
        
        return refs
