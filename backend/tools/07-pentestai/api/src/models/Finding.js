const mongoose = require('mongoose');

const findingSchema = new mongoose.Schema({
  userId: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },
  testId: { type: mongoose.Schema.Types.ObjectId, ref: 'PenTest', required: true },
  targetId: { type: mongoose.Schema.Types.ObjectId, ref: 'PenTestTarget', required: true },
  title: { type: String, required: true },
  category: {
    type: String,
    enum: ['injection', 'auth', 'xss', 'misconfig', 'crypto', 'ssrf', 'xxe', 'deserialization', 'access_control', 'other'],
    required: true
  },
  severity: {
    type: String,
    enum: ['critical', 'high', 'medium', 'low', 'info'],
    required: true
  },
  cvssScore: { type: Number, min: 0, max: 10 },
  cvssVector: String,
  description: { type: String, required: true },
  technicalDetails: {
    endpoint: String,
    method: String,
    parameter: String,
    payload: String,
    evidence: String,
    request: String,
    response: String
  },
  exploitation: {
    difficulty: { type: String, enum: ['trivial', 'easy', 'moderate', 'hard', 'expert'] },
    exploitAvailable: { type: Boolean, default: false },
    exploitCode: String,
    prerequisites: [String]
  },
  impact: {
    confidentiality: { type: String, enum: ['none', 'low', 'high'] },
    integrity: { type: String, enum: ['none', 'low', 'high'] },
    availability: { type: String, enum: ['none', 'low', 'high'] }
  },
  remediation: {
    description: String,
    code: String,
    references: [String],
    priority: { type: String, enum: ['immediate', 'short_term', 'medium_term', 'long_term'] }
  },
  references: [{
    type: { type: String, enum: ['cve', 'cwe', 'owasp', 'url'] },
    id: String,
    url: String
  }],
  status: {
    type: String,
    enum: ['open', 'confirmed', 'false_positive', 'remediated', 'accepted'],
    default: 'open'
  },
  verifiedAt: Date,
  createdAt: { type: Date, default: Date.now }
});

findingSchema.index({ testId: 1, severity: 1 });
findingSchema.index({ userId: 1, status: 1 });
findingSchema.index({ category: 1 });

module.exports = mongoose.model('PenTestFinding', findingSchema);
