const mongoose = require('mongoose');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ” SCAN MODEL - Manages network and vulnerability scans
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const scanSchema = new mongoose.Schema({
  userId: { 
    type: mongoose.Schema.Types.ObjectId, 
    ref: 'User', 
    required: true 
  },
  engagementId: { 
    type: mongoose.Schema.Types.ObjectId, 
    ref: 'PenTestEngagement' 
  },
  targetId: { 
    type: mongoose.Schema.Types.ObjectId, 
    ref: 'PenTestTarget',
    required: true
  },
  
  // Scan Identification
  scanId: {
    type: String,
    required: true,
    unique: true,
    index: true
  },
  name: {
    type: String,
    trim: true
  },
  
  // Scan Type
  scanType: {
    type: String,
    enum: [
      'port_scan',
      'service_scan',
      'vulnerability_scan',
      'web_scan',
      'ssl_scan',
      'dns_scan',
      'subdomain_enum',
      'directory_bruteforce',
      'network_discovery',
      'os_fingerprint',
      'full_scan',
      'custom'
    ],
    required: true
  },
  
  // Target Configuration
  target: {
    hosts: [String],              // IPs, hostnames, CIDR ranges
    ports: [String],              // Port ranges: "1-1000", "80,443,8080"
    excludedHosts: [String],
    excludedPorts: [String]
  },
  
  // Scan Configuration
  configuration: {
    tool: {
      type: String,
      enum: ['nmap', 'masscan', 'zap', 'nikto', 'nuclei', 'sqlmap', 'custom'],
      default: 'nmap'
    },
    timing: {
      type: String,
      enum: ['T0', 'T1', 'T2', 'T3', 'T4', 'T5'],  // Nmap timing templates
      default: 'T3'
    },
    intensity: {
      type: String,
      enum: ['stealth', 'light', 'normal', 'aggressive', 'insane'],
      default: 'normal'
    },
    options: {
      tcpScan: { type: Boolean, default: true },
      udpScan: { type: Boolean, default: false },
      synScan: { type: Boolean, default: true },
      versionDetection: { type: Boolean, default: true },
      osDetection: { type: Boolean, default: true },
      scriptScan: { type: Boolean, default: false },
      scripts: [String],           // NSE scripts to run
      serviceProbes: { type: Boolean, default: true },
      traceroute: { type: Boolean, default: false }
    },
    authentication: {
      enabled: { type: Boolean, default: false },
      type: { type: String, enum: ['basic', 'digest', 'ntlm', 'bearer', 'form'] },
      credentials: mongoose.Schema.Types.Mixed
    },
    maxRetries: { type: Number, default: 2 },
    timeout: { type: Number, default: 3600 },  // seconds
    rateLimit: { type: Number },               // packets per second
    randomizeHosts: { type: Boolean, default: false },
    fragmentPackets: { type: Boolean, default: false }
  },
  
  // Status Tracking
  status: {
    type: String,
    enum: ['queued', 'initializing', 'running', 'paused', 'completed', 'failed', 'cancelled'],
    default: 'queued'
  },
  progress: {
    percent: { type: Number, default: 0, min: 0, max: 100 },
    hostsScanned: { type: Number, default: 0 },
    totalHosts: { type: Number, default: 0 },
    portsScanned: { type: Number, default: 0 },
    currentPhase: String,
    estimatedTimeRemaining: Number  // seconds
  },
  
  // Timing
  timing: {
    scheduledAt: Date,
    queuedAt: { type: Date, default: Date.now },
    startedAt: Date,
    pausedAt: Date,
    resumedAt: Date,
    completedAt: Date,
    duration: Number  // milliseconds
  },
  
  // Results Summary
  results: {
    hostsDiscovered: { type: Number, default: 0 },
    hostsUp: { type: Number, default: 0 },
    hostsDown: { type: Number, default: 0 },
    portsOpen: { type: Number, default: 0 },
    portsClosed: { type: Number, default: 0 },
    portsFiltered: { type: Number, default: 0 },
    servicesIdentified: { type: Number, default: 0 },
    vulnerabilitiesFound: { type: Number, default: 0 },
    
    bySeverity: {
      critical: { type: Number, default: 0 },
      high: { type: Number, default: 0 },
      medium: { type: Number, default: 0 },
      low: { type: Number, default: 0 },
      info: { type: Number, default: 0 }
    }
  },
  
  // Discovered Hosts
  hosts: [{
    ip: { type: String, required: true },
    hostname: String,
    mac: String,
    vendor: String,
    status: { type: String, enum: ['up', 'down', 'unknown'] },
    latency: Number,  // ms
    
    os: {
      name: String,
      family: String,
      version: String,
      accuracy: Number,
      cpe: [String]
    },
    
    ports: [{
      port: { type: Number, required: true },
      protocol: { type: String, enum: ['tcp', 'udp'], default: 'tcp' },
      state: { type: String, enum: ['open', 'closed', 'filtered', 'open|filtered'] },
      service: {
        name: String,
        product: String,
        version: String,
        extraInfo: String,
        cpe: [String],
        confidence: Number
      },
      scripts: [{
        name: String,
        output: String
      }],
      vulnerabilities: [{
        id: String,
        title: String,
        severity: String,
        cvss: Number,
        description: String,
        references: [String]
      }]
    }],
    
    traceroute: [{
      hop: Number,
      ip: String,
      hostname: String,
      rtt: Number
    }]
  }],
  
  // Raw Output
  rawOutput: {
    xml: String,
    json: mongoose.Schema.Types.Mixed,
    text: String,
    storagePath: String  // Path to stored output file
  },
  
  // Error Information
  error: {
    code: String,
    message: String,
    details: String,
    occurredAt: Date
  },
  
  // Linked Records
  findings: [{ type: mongoose.Schema.Types.ObjectId, ref: 'PenTestFinding' }],
  
  // Metadata
  tags: [String],
  notes: String,
  
  // Audit Trail
  createdAt: { type: Date, default: Date.now },
  updatedAt: { type: Date, default: Date.now },
  createdBy: { type: mongoose.Schema.Types.ObjectId, ref: 'User' }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š INDEXES FOR OPTIMAL QUERY PERFORMANCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Primary lookup indexes
scanSchema.index({ userId: 1, status: 1 });
scanSchema.index({ engagementId: 1 });
scanSchema.index({ targetId: 1 });
scanSchema.index({ scanId: 1 });

// Status and type queries
scanSchema.index({ scanType: 1, status: 1 });
scanSchema.index({ status: 1, 'timing.startedAt': -1 });

// Timeline queries
scanSchema.index({ 'timing.scheduledAt': 1 });
scanSchema.index({ 'timing.startedAt': -1 });
scanSchema.index({ createdAt: -1 });

// Results queries
scanSchema.index({ 'results.vulnerabilitiesFound': -1 });
scanSchema.index({ 'results.bySeverity.critical': -1 });

// Host queries
scanSchema.index({ 'hosts.ip': 1 });

// Compound indexes
scanSchema.index({ userId: 1, scanType: 1, status: 1 });
scanSchema.index({ engagementId: 1, scanType: 1 });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”§ MIDDLEWARE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

scanSchema.pre('save', function(next) {
  this.updatedAt = new Date();
  next();
});

// Auto-generate scanId
scanSchema.pre('save', function(next) {
  if (!this.scanId) {
    const timestamp = Date.now().toString(36);
    const random = Math.random().toString(36).substring(2, 8);
    this.scanId = `scan_${timestamp}${random}`;
  }
  next();
});

// Calculate duration on completion
scanSchema.pre('save', function(next) {
  if (this.status === 'completed' && this.timing.startedAt && !this.timing.duration) {
    this.timing.completedAt = new Date();
    this.timing.duration = this.timing.completedAt - this.timing.startedAt;
  }
  next();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“¤ EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

module.exports = mongoose.model('PenTestScan', scanSchema);
