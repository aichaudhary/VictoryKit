const Target = require('../models/Target');
const mlService = require('../services/mlService');
const { ApiResponse, ApiError } = require('../../../../shared');

exports.createTarget = async (req, res, next) => {
  try {
    const { name, type, host, port, protocol, scope, authentication } = req.body;
    
    const existing = await Target.findOne({ userId: req.user.id, host });
    if (existing) {
      throw new ApiError(409, 'Target already exists');
    }

    const target = await Target.create({
      userId: req.user.id,
      name,
      type,
      host,
      port,
      protocol,
      scope,
      authentication
    });

    // AI analysis of target
    const analysis = await mlService.analyzeTarget({ host, type, protocol });
    if (analysis.technology) {
      target.metadata.technology = analysis.technology;
      await target.save();
    }

    res.status(201).json(ApiResponse.success(target, 'Target created'));
  } catch (error) {
    next(error);
  }
};

exports.getTargets = async (req, res, next) => {
  try {
    const { status, type, page = 1, limit = 20 } = req.query;
    const filter = { userId: req.user.id };
    
    if (status) filter.status = status;
    if (type) filter.type = type;

    const targets = await Target.find(filter)
      .sort({ createdAt: -1 })
      .skip((page - 1) * limit)
      .limit(parseInt(limit));

    const total = await Target.countDocuments(filter);

    res.json(ApiResponse.success({
      targets,
      pagination: { page: parseInt(page), limit: parseInt(limit), total }
    }));
  } catch (error) {
    next(error);
  }
};

exports.getTarget = async (req, res, next) => {
  try {
    const target = await Target.findOne({
      _id: req.params.id,
      userId: req.user.id
    });

    if (!target) {
      throw new ApiError(404, 'Target not found');
    }

    res.json(ApiResponse.success(target));
  } catch (error) {
    next(error);
  }
};

exports.updateTarget = async (req, res, next) => {
  try {
    const updates = req.body;
    delete updates.userId;

    const target = await Target.findOneAndUpdate(
      { _id: req.params.id, userId: req.user.id },
      updates,
      { new: true, runValidators: true }
    );

    if (!target) {
      throw new ApiError(404, 'Target not found');
    }

    res.json(ApiResponse.success(target, 'Target updated'));
  } catch (error) {
    next(error);
  }
};

exports.deleteTarget = async (req, res, next) => {
  try {
    const target = await Target.findOneAndDelete({
      _id: req.params.id,
      userId: req.user.id
    });

    if (!target) {
      throw new ApiError(404, 'Target not found');
    }

    res.json(ApiResponse.success(null, 'Target deleted'));
  } catch (error) {
    next(error);
  }
};

exports.analyzeTarget = async (req, res, next) => {
  try {
    const target = await Target.findOne({
      _id: req.params.id,
      userId: req.user.id
    });

    if (!target) {
      throw new ApiError(404, 'Target not found');
    }

    const analysis = await mlService.analyzeTarget({
      host: target.host,
      type: target.type,
      protocol: target.protocol,
      port: target.port
    });

    target.metadata.technology = analysis.technology || [];
    await target.save();

    res.json(ApiResponse.success({
      target,
      analysis
    }, 'Target analyzed'));
  } catch (error) {
    next(error);
  }
};
