const mongoose = require('mongoose');

const vulnerabilitySchema = new mongoose.Schema({
  userId: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true, index: true },
  vulnId: { type: String, required: true, unique: true },
  cve: { type: String, index: true },
  title: { type: String, required: true },
  description: String,
  
  severity: { type: String, enum: ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO'], required: true },
  cvssScore: { type: Number, min: 0, max: 10 },
  cvssVector: String,
  
  affectedAssets: [{
    assetId: String,
    assetType: String,
    component: String,
    version: String
  }],
  
  exploit: {
    available: Boolean,
    public: Boolean,
    metasploitModule: String,
    exploitDbId: String,
    pocs: [String]
  },
  
  remediation: {
    solution: String,
    patchAvailable: Boolean,
    patchUrl: String,
    workaround: String,
    estimatedEffort: String
  },
  
  cwe: String,
  owasp: String,
  references: [String],
  
  status: { type: String, enum: ['open', 'acknowledged', 'in_progress', 'resolved', 'false_positive'], default: 'open' },
  firstDetected: { type: Date, default: Date.now },
  lastSeen: Date,
  resolvedAt: Date
}, { timestamps: true });

vulnerabilitySchema.index({ userId: 1, severity: -1 });
vulnerabilitySchema.index({ cve: 1 });
vulnerabilitySchema.index({ status: 1 });

module.exports = mongoose.model('Vulnerability', vulnerabilitySchema);
