const Vulnerability = require('../models/Vulnerability.model');
const VulnScan = require('../models/Scan.model');
const { ApiResponse, ApiError } = require('../../../../shared');

class VulnerabilityController {
  async getAllVulnerabilities(req, res, next) {
    try {
      const { page = 1, limit = 20, severity, status } = req.query;
      const query = { userId: req.user.id };
      if (severity) query.severity = severity;
      if (status) query.status = status;

      const vulns = await Vulnerability.find(query).sort({ cvssScore: -1 }).limit(limit * 1).skip((page - 1) * limit);
      const total = await Vulnerability.countDocuments(query);
      res.json(ApiResponse.success({ vulnerabilities: vulns, pagination: { total, page: parseInt(page), limit: parseInt(limit), pages: Math.ceil(total / limit) } }));
    } catch (error) {
      next(error);
    }
  }

  async getVulnerabilityById(req, res, next) {
    try {
      const vuln = await Vulnerability.findById(req.params.id);
      if (!vuln) throw ApiError.notFound('Vulnerability not found');
      if (vuln.userId.toString() !== req.user.id && req.user.role !== 'admin') throw ApiError.forbidden('Access denied');
      res.json(ApiResponse.success(vuln));
    } catch (error) {
      next(error);
    }
  }

  async updateVulnerability(req, res, next) {
    try {
      const vuln = await Vulnerability.findById(req.params.id);
      if (!vuln) throw ApiError.notFound('Vulnerability not found');
      if (vuln.userId.toString() !== req.user.id && req.user.role !== 'admin') throw ApiError.forbidden('Access denied');
      
      Object.assign(vuln, req.body);
      if (req.body.status === 'resolved') vuln.resolvedAt = new Date();
      await vuln.save();
      
      res.json(ApiResponse.success(vuln, 'Vulnerability updated'));
    } catch (error) {
      next(error);
    }
  }

  async deleteVulnerability(req, res, next) {
    try {
      const vuln = await Vulnerability.findById(req.params.id);
      if (!vuln) throw ApiError.notFound('Vulnerability not found');
      if (vuln.userId.toString() !== req.user.id && req.user.role !== 'admin') throw ApiError.forbidden('Access denied');
      await vuln.deleteOne();
      res.json(ApiResponse.success(null, 'Vulnerability deleted'));
    } catch (error) {
      next(error);
    }
  }
}

module.exports = new VulnerabilityController();
