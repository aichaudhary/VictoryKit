/**
 * MITRE ATT&CK Mapping Service
 * Maps malware behaviors to MITRE ATT&CK framework
 * https://attack.mitre.org/
 */
class MitreAttackService {
  constructor() {
    this.techniques = this.initializeTechniques();
    this.tactics = this.initializeTactics();
  }

  initializeTactics() {
    return {
      'TA0001': { name: 'Initial Access', description: 'Techniques to gain initial foothold' },
      'TA0002': { name: 'Execution', description: 'Techniques to run malicious code' },
      'TA0003': { name: 'Persistence', description: 'Techniques to maintain presence' },
      'TA0004': { name: 'Privilege Escalation', description: 'Techniques to gain higher permissions' },
      'TA0005': { name: 'Defense Evasion', description: 'Techniques to avoid detection' },
      'TA0006': { name: 'Credential Access', description: 'Techniques to steal credentials' },
      'TA0007': { name: 'Discovery', description: 'Techniques to learn about the environment' },
      'TA0008': { name: 'Lateral Movement', description: 'Techniques to move through environment' },
      'TA0009': { name: 'Collection', description: 'Techniques to gather target data' },
      'TA0010': { name: 'Exfiltration', description: 'Techniques to steal data' },
      'TA0011': { name: 'Command and Control', description: 'Techniques to communicate with systems' },
      'TA0040': { name: 'Impact', description: 'Techniques to disrupt availability or integrity' }
    };
  }

  initializeTechniques() {
    return {
      // Initial Access
      'T1566': {
        name: 'Phishing',
        tactic: 'TA0001',
        description: 'Adversaries may send phishing messages to gain access',
        subtechniques: {
          'T1566.001': 'Spearphishing Attachment',
          'T1566.002': 'Spearphishing Link',
          'T1566.003': 'Spearphishing via Service'
        },
        detection: ['Email analysis', 'URL reputation', 'Attachment scanning'],
        mitigation: ['User training', 'Email filtering', 'Attachment sandboxing']
      },
      'T1189': {
        name: 'Drive-by Compromise',
        tactic: 'TA0001',
        description: 'Adversaries may gain access through a user visiting a website',
        detection: ['Network traffic analysis', 'Browser exploit detection'],
        mitigation: ['Browser updates', 'Script blocking', 'Network segmentation']
      },

      // Execution
      'T1059': {
        name: 'Command and Scripting Interpreter',
        tactic: 'TA0002',
        description: 'Adversaries may abuse command and script interpreters',
        subtechniques: {
          'T1059.001': 'PowerShell',
          'T1059.003': 'Windows Command Shell',
          'T1059.005': 'Visual Basic',
          'T1059.006': 'Python',
          'T1059.007': 'JavaScript'
        },
        detection: ['Script block logging', 'Command-line monitoring'],
        mitigation: ['Execution policies', 'Script signing', 'AMSI']
      },
      'T1204': {
        name: 'User Execution',
        tactic: 'TA0002',
        description: 'Adversaries may rely on user execution for initial code execution',
        subtechniques: {
          'T1204.001': 'Malicious Link',
          'T1204.002': 'Malicious File'
        },
        detection: ['Process monitoring', 'File execution logging'],
        mitigation: ['User training', 'Application whitelisting']
      },
      'T1203': {
        name: 'Exploitation for Client Execution',
        tactic: 'TA0002',
        description: 'Adversaries may exploit software vulnerabilities',
        detection: ['Crash analysis', 'Exploit detection'],
        mitigation: ['Patching', 'Sandboxing', 'DEP/ASLR']
      },

      // Persistence
      'T1547': {
        name: 'Boot or Logon Autostart Execution',
        tactic: 'TA0003',
        description: 'Adversaries may configure autostart execution',
        subtechniques: {
          'T1547.001': 'Registry Run Keys / Startup Folder',
          'T1547.004': 'Winlogon Helper DLL',
          'T1547.005': 'Security Support Provider',
          'T1547.009': 'Shortcut Modification'
        },
        detection: ['Registry monitoring', 'Startup folder monitoring'],
        mitigation: ['Restrict registry permissions', 'Audit startup locations']
      },
      'T1053': {
        name: 'Scheduled Task/Job',
        tactic: 'TA0003',
        description: 'Adversaries may abuse task scheduling',
        subtechniques: {
          'T1053.005': 'Scheduled Task',
          'T1053.003': 'Cron'
        },
        detection: ['Task scheduler logging', 'Cron job monitoring'],
        mitigation: ['Privilege restrictions', 'Task auditing']
      },
      'T1543': {
        name: 'Create or Modify System Process',
        tactic: 'TA0003',
        description: 'Adversaries may create or modify system processes',
        subtechniques: {
          'T1543.003': 'Windows Service'
        },
        detection: ['Service creation monitoring', 'SCM auditing'],
        mitigation: ['Restrict service creation', 'Audit service changes']
      },

      // Privilege Escalation
      'T1055': {
        name: 'Process Injection',
        tactic: 'TA0004',
        description: 'Adversaries may inject code into processes',
        subtechniques: {
          'T1055.001': 'Dynamic-link Library Injection',
          'T1055.002': 'Portable Executable Injection',
          'T1055.003': 'Thread Execution Hijacking',
          'T1055.004': 'Asynchronous Procedure Call',
          'T1055.012': 'Process Hollowing'
        },
        detection: ['API monitoring', 'Memory forensics'],
        mitigation: ['Exploit protection', 'Memory integrity']
      },
      'T1068': {
        name: 'Exploitation for Privilege Escalation',
        tactic: 'TA0004',
        description: 'Adversaries may exploit vulnerabilities for elevation',
        detection: ['Exploit detection', 'Crash analysis'],
        mitigation: ['Patching', 'Least privilege', 'Sandboxing']
      },

      // Defense Evasion
      'T1027': {
        name: 'Obfuscated Files or Information',
        tactic: 'TA0005',
        description: 'Adversaries may obfuscate content',
        subtechniques: {
          'T1027.002': 'Software Packing',
          'T1027.005': 'Indicator Removal from Tools',
          'T1027.009': 'Embedded Payloads'
        },
        detection: ['Entropy analysis', 'Packer detection'],
        mitigation: ['Deobfuscation tools', 'Sandbox analysis']
      },
      'T1070': {
        name: 'Indicator Removal on Host',
        tactic: 'TA0005',
        description: 'Adversaries may delete evidence',
        subtechniques: {
          'T1070.001': 'Clear Windows Event Logs',
          'T1070.004': 'File Deletion'
        },
        detection: ['Log monitoring', 'File integrity monitoring'],
        mitigation: ['Remote logging', 'Log protection']
      },
      'T1497': {
        name: 'Virtualization/Sandbox Evasion',
        tactic: 'TA0005',
        description: 'Adversaries may check for VM/sandbox',
        subtechniques: {
          'T1497.001': 'System Checks'
        },
        detection: ['Behavior analysis', 'Multiple environment testing'],
        mitigation: ['Environment hardening', 'Sandbox improvements']
      },
      'T1622': {
        name: 'Debugger Evasion',
        tactic: 'TA0005',
        description: 'Adversaries may check for debuggers',
        detection: ['Behavioral analysis', 'API monitoring'],
        mitigation: ['Anti-anti-debug techniques']
      },
      'T1014': {
        name: 'Rootkit',
        tactic: 'TA0005',
        description: 'Adversaries may use rootkits to hide activity',
        detection: ['Kernel integrity monitoring', 'Memory forensics'],
        mitigation: ['Secure boot', 'Driver signing']
      },

      // Credential Access
      'T1003': {
        name: 'OS Credential Dumping',
        tactic: 'TA0006',
        description: 'Adversaries may dump credentials',
        subtechniques: {
          'T1003.001': 'LSASS Memory',
          'T1003.002': 'Security Account Manager',
          'T1003.003': 'NTDS'
        },
        detection: ['LSASS protection', 'Credential Guard'],
        mitigation: ['Protected Users', 'Credential Guard']
      },
      'T1555': {
        name: 'Credentials from Password Stores',
        tactic: 'TA0006',
        description: 'Adversaries may search for credential stores',
        subtechniques: {
          'T1555.003': 'Credentials from Web Browsers',
          'T1555.004': 'Windows Credential Manager'
        },
        detection: ['File access monitoring', 'API monitoring'],
        mitigation: ['Password managers', 'MFA']
      },
      'T1056': {
        name: 'Input Capture',
        tactic: 'TA0006',
        description: 'Adversaries may capture user input',
        subtechniques: {
          'T1056.001': 'Keylogging'
        },
        detection: ['API monitoring', 'Hook detection'],
        mitigation: ['Input validation', 'Virtual keyboards']
      },

      // Discovery
      'T1082': {
        name: 'System Information Discovery',
        tactic: 'TA0007',
        description: 'Adversaries may gather system information',
        detection: ['Process monitoring', 'API monitoring'],
        mitigation: ['Limit information exposure']
      },
      'T1083': {
        name: 'File and Directory Discovery',
        tactic: 'TA0007',
        description: 'Adversaries may enumerate files',
        detection: ['File access monitoring'],
        mitigation: ['File permissions', 'Access controls']
      },

      // Lateral Movement
      'T1021': {
        name: 'Remote Services',
        tactic: 'TA0008',
        description: 'Adversaries may use remote services for lateral movement',
        subtechniques: {
          'T1021.001': 'Remote Desktop Protocol',
          'T1021.002': 'SMB/Windows Admin Shares',
          'T1021.003': 'Distributed Component Object Model',
          'T1021.006': 'Windows Remote Management'
        },
        detection: ['Network monitoring', 'Authentication logging'],
        mitigation: ['Network segmentation', 'MFA']
      },
      'T1570': {
        name: 'Lateral Tool Transfer',
        tactic: 'TA0008',
        description: 'Adversaries may transfer tools between systems',
        detection: ['File transfer monitoring', 'Network analysis'],
        mitigation: ['Network segmentation', 'Application control']
      },
      'T1210': {
        name: 'Exploitation of Remote Services',
        tactic: 'TA0008',
        description: 'Adversaries may exploit remote services',
        detection: ['Network IDS', 'Exploit detection'],
        mitigation: ['Patching', 'Network segmentation']
      },

      // Collection
      'T1113': {
        name: 'Screen Capture',
        tactic: 'TA0009',
        description: 'Adversaries may capture screen contents',
        detection: ['API monitoring', 'Process analysis'],
        mitigation: ['Execution prevention']
      },
      'T1125': {
        name: 'Video Capture',
        tactic: 'TA0009',
        description: 'Adversaries may capture video from webcams',
        detection: ['Device access monitoring'],
        mitigation: ['Device control', 'Camera covers']
      },
      'T1560': {
        name: 'Archive Collected Data',
        tactic: 'TA0009',
        description: 'Adversaries may compress collected data',
        subtechniques: {
          'T1560.001': 'Archive via Utility'
        },
        detection: ['Process monitoring', 'File creation monitoring'],
        mitigation: ['DLP', 'Execution prevention']
      },

      // Exfiltration
      'T1048': {
        name: 'Exfiltration Over Alternative Protocol',
        tactic: 'TA0010',
        description: 'Adversaries may use alternative protocols for exfiltration',
        subtechniques: {
          'T1048.003': 'Exfiltration Over Unencrypted Non-C2 Protocol'
        },
        detection: ['Network monitoring', 'DLP'],
        mitigation: ['Network segmentation', 'Egress filtering']
      },
      'T1567': {
        name: 'Exfiltration Over Web Service',
        tactic: 'TA0010',
        description: 'Adversaries may use web services for exfiltration',
        subtechniques: {
          'T1567.002': 'Exfiltration to Cloud Storage'
        },
        detection: ['Cloud API monitoring', 'DLP'],
        mitigation: ['Cloud DLP', 'Web filtering']
      },
      'T1020': {
        name: 'Automated Exfiltration',
        tactic: 'TA0010',
        description: 'Adversaries may automate data exfiltration',
        detection: ['Network traffic analysis', 'Scheduled task monitoring'],
        mitigation: ['DLP', 'Network monitoring']
      },

      // Command and Control
      'T1071': {
        name: 'Application Layer Protocol',
        tactic: 'TA0011',
        description: 'Adversaries may use application layer protocols for C2',
        subtechniques: {
          'T1071.001': 'Web Protocols',
          'T1071.002': 'File Transfer Protocols',
          'T1071.003': 'Mail Protocols',
          'T1071.004': 'DNS'
        },
        detection: ['Network monitoring', 'Protocol analysis'],
        mitigation: ['Network segmentation', 'DNS filtering']
      },
      'T1573': {
        name: 'Encrypted Channel',
        tactic: 'TA0011',
        description: 'Adversaries may use encrypted channels for C2',
        subtechniques: {
          'T1573.001': 'Symmetric Cryptography',
          'T1573.002': 'Asymmetric Cryptography'
        },
        detection: ['SSL inspection', 'Traffic analysis'],
        mitigation: ['SSL inspection', 'Network monitoring']
      },
      'T1095': {
        name: 'Non-Application Layer Protocol',
        tactic: 'TA0011',
        description: 'Adversaries may use non-application protocols for C2',
        detection: ['Network monitoring', 'Protocol analysis'],
        mitigation: ['Network filtering', 'IDS/IPS']
      },
      'T1105': {
        name: 'Ingress Tool Transfer',
        tactic: 'TA0011',
        description: 'Adversaries may transfer tools from external systems',
        detection: ['Network monitoring', 'File monitoring'],
        mitigation: ['Network filtering', 'Application control']
      },

      // Impact
      'T1486': {
        name: 'Data Encrypted for Impact',
        tactic: 'TA0040',
        description: 'Adversaries may encrypt data for ransom (ransomware)',
        detection: ['File system monitoring', 'Entropy analysis'],
        mitigation: ['Backups', 'File access controls']
      },
      'T1491': {
        name: 'Defacement',
        tactic: 'TA0040',
        description: 'Adversaries may modify visual content',
        subtechniques: {
          'T1491.001': 'Internal Defacement'
        },
        detection: ['File integrity monitoring'],
        mitigation: ['Backups', 'Access controls']
      },
      'T1496': {
        name: 'Resource Hijacking',
        tactic: 'TA0040',
        description: 'Adversaries may hijack resources (cryptomining)',
        detection: ['Resource monitoring', 'Process analysis'],
        mitigation: ['Resource limits', 'Application control']
      },
      'T1112': {
        name: 'Modify Registry',
        tactic: 'TA0005',
        description: 'Adversaries may modify the registry',
        detection: ['Registry monitoring'],
        mitigation: ['Registry auditing', 'Access controls']
      }
    };
  }

  /**
   * Get technique details by ID
   */
  getTechnique(techniqueId) {
    const technique = this.techniques[techniqueId];
    if (!technique) return null;

    const tactic = this.tactics[technique.tactic];
    return {
      id: techniqueId,
      ...technique,
      tacticName: tactic?.name,
      tacticDescription: tactic?.description,
      url: `https://attack.mitre.org/techniques/${techniqueId.replace('.', '/')}/`
    };
  }

  /**
   * Get all techniques for a tactic
   */
  getTechniquesByTactic(tacticId) {
    return Object.entries(this.techniques)
      .filter(([_, t]) => t.tactic === tacticId)
      .map(([id, t]) => ({ id, ...t }));
  }

  /**
   * Map behaviors to MITRE techniques
   */
  mapBehaviors(behaviors) {
    const mappings = [];

    const behaviorPatterns = {
      'registry_modification': ['T1547.001', 'T1112'],
      'process_injection': ['T1055', 'T1055.001', 'T1055.002', 'T1055.012'],
      'credential_access': ['T1003', 'T1555', 'T1555.003'],
      'keylogging': ['T1056.001'],
      'screen_capture': ['T1113'],
      'file_encryption': ['T1486'],
      'network_connection': ['T1071', 'T1095'],
      'persistence': ['T1547', 'T1053', 'T1543'],
      'defense_evasion': ['T1027', 'T1070', 'T1497', 'T1622'],
      'data_exfiltration': ['T1048', 'T1567', 'T1020'],
      'lateral_movement': ['T1021', 'T1570', 'T1210'],
      'command_execution': ['T1059', 'T1059.001', 'T1059.003'],
      'rootkit': ['T1014', 'T1068'],
      'cryptominer': ['T1496']
    };

    for (const behavior of behaviors) {
      const key = behavior.toLowerCase().replace(/[^a-z_]/g, '_');
      const techniques = behaviorPatterns[key] || [];
      
      for (const techId of techniques) {
        const technique = this.getTechnique(techId);
        if (technique) {
          mappings.push({
            behavior,
            technique: technique
          });
        }
      }
    }

    return mappings;
  }

  /**
   * Generate MITRE ATT&CK report
   */
  generateReport(techniqueIds) {
    const report = {
      generatedAt: new Date().toISOString(),
      techniquesCount: techniqueIds.length,
      tacticsHit: new Set(),
      techniques: [],
      matrix: {},
      riskLevel: 'LOW'
    };

    for (const techId of techniqueIds) {
      const technique = this.getTechnique(techId);
      if (technique) {
        report.techniques.push(technique);
        report.tacticsHit.add(technique.tactic);
        
        if (!report.matrix[technique.tacticName]) {
          report.matrix[technique.tacticName] = [];
        }
        report.matrix[technique.tacticName].push({
          id: techId,
          name: technique.name
        });
      }
    }

    report.tacticsHit = Array.from(report.tacticsHit);
    
    // Determine risk level
    if (report.tacticsHit.length >= 5 || 
        techniqueIds.some(t => ['T1486', 'T1003', 'T1014'].includes(t))) {
      report.riskLevel = 'CRITICAL';
    } else if (report.tacticsHit.length >= 3) {
      report.riskLevel = 'HIGH';
    } else if (report.tacticsHit.length >= 2) {
      report.riskLevel = 'MEDIUM';
    }

    return report;
  }

  /**
   * Get all tactics
   */
  getAllTactics() {
    return Object.entries(this.tactics).map(([id, t]) => ({ id, ...t }));
  }

  /**
   * Get all techniques
   */
  getAllTechniques() {
    return Object.entries(this.techniques).map(([id, t]) => ({ id, ...t }));
  }

  /**
   * Search techniques
   */
  searchTechniques(query) {
    const queryLower = query.toLowerCase();
    return Object.entries(this.techniques)
      .filter(([id, t]) => 
        id.toLowerCase().includes(queryLower) ||
        t.name.toLowerCase().includes(queryLower) ||
        t.description.toLowerCase().includes(queryLower)
      )
      .map(([id, t]) => ({ id, ...t }));
  }
}

module.exports = new MitreAttackService();
