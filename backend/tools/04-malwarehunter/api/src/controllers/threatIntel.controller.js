const { ApiResponse, ApiError } = require('../../../../../shared');
const threatIntelService = require('../services/threatIntel.service');
const yaraService = require('../services/yara.service');
const mitreService = require('../services/mitre.service');

/**
 * Threat Intelligence Controller
 * Handles all threat intel, YARA, and MITRE ATT&CK endpoints
 */
class ThreatIntelController {
  // ============================================
  // COMPREHENSIVE LOOKUP
  // ============================================

  /**
   * Comprehensive hash lookup across all services
   */
  async comprehensiveLookup(req, res, next) {
    try {
      const { hash } = req.params;
      
      if (!hash || hash.length < 32) {
        throw ApiError.badRequest('Invalid hash format');
      }

      const result = await threatIntelService.comprehensiveHashLookup(hash);
      
      // Also run YARA scan if we have cached sample data
      // result.yaraAnalysis = yaraService.scan(hash); // Would need actual file data
      
      // Map to MITRE ATT&CK if we have behaviors
      if (result.sources.hybridAnalysis?.mitreTechniques) {
        result.mitreMapping = mitreService.generateReport(
          result.sources.hybridAnalysis.mitreTechniques
        );
      }

      res.json(ApiResponse.success(result, 'Comprehensive lookup completed'));
    } catch (error) {
      next(error);
    }
  }

  /**
   * Get API configuration status
   */
  async getApiStatus(req, res, next) {
    try {
      const status = threatIntelService.getApiStatus();
      res.json(ApiResponse.success(status, 'API configuration status'));
    } catch (error) {
      next(error);
    }
  }

  // ============================================
  // VIRUSTOTAL
  // ============================================

  async virusTotalLookup(req, res, next) {
    try {
      const { hash } = req.params;
      const result = await threatIntelService.virusTotalHashLookup(hash);
      res.json(ApiResponse.success(result));
    } catch (error) {
      next(error);
    }
  }

  async virusTotalUpload(req, res, next) {
    try {
      const { fileData, fileName } = req.body;
      const buffer = Buffer.from(fileData, 'base64');
      const result = await threatIntelService.virusTotalUpload(buffer, fileName);
      res.json(ApiResponse.success(result, 'File submitted to VirusTotal'));
    } catch (error) {
      next(error);
    }
  }

  async virusTotalAnalysis(req, res, next) {
    try {
      const { analysisId } = req.params;
      const result = await threatIntelService.virusTotalGetAnalysis(analysisId);
      res.json(ApiResponse.success(result));
    } catch (error) {
      next(error);
    }
  }

  // ============================================
  // HYBRID ANALYSIS
  // ============================================

  async hybridAnalysisLookup(req, res, next) {
    try {
      const { hash } = req.params;
      const result = await threatIntelService.hybridAnalysisHashLookup(hash);
      res.json(ApiResponse.success(result));
    } catch (error) {
      next(error);
    }
  }

  async hybridAnalysisSubmit(req, res, next) {
    try {
      const { fileData, fileName, environmentId } = req.body;
      const buffer = Buffer.from(fileData, 'base64');
      const result = await threatIntelService.hybridAnalysisSubmit(buffer, fileName, environmentId);
      res.json(ApiResponse.success(result, 'File submitted to Hybrid Analysis'));
    } catch (error) {
      next(error);
    }
  }

  async hybridAnalysisReport(req, res, next) {
    try {
      const { sha256 } = req.params;
      const result = await threatIntelService.hybridAnalysisReport(sha256);
      res.json(ApiResponse.success(result));
    } catch (error) {
      next(error);
    }
  }

  // ============================================
  // MALWAREBAZAAR
  // ============================================

  async malwareBazaarLookup(req, res, next) {
    try {
      const { hash } = req.params;
      const result = await threatIntelService.malwareBazaarLookup(hash);
      res.json(ApiResponse.success(result));
    } catch (error) {
      next(error);
    }
  }

  async malwareBazaarRecent(req, res, next) {
    try {
      const limit = parseInt(req.query.limit) || 50;
      const result = await threatIntelService.malwareBazaarRecent(limit);
      res.json(ApiResponse.success(result));
    } catch (error) {
      next(error);
    }
  }

  // ============================================
  // ANY.RUN
  // ============================================

  async anyRunSubmit(req, res, next) {
    try {
      const { fileUrl, fileName } = req.body;
      const result = await threatIntelService.anyRunSubmit(fileUrl, fileName);
      res.json(ApiResponse.success(result, 'Task submitted to ANY.RUN'));
    } catch (error) {
      next(error);
    }
  }

  async anyRunReport(req, res, next) {
    try {
      const { taskId } = req.params;
      const result = await threatIntelService.anyRunReport(taskId);
      res.json(ApiResponse.success(result));
    } catch (error) {
      next(error);
    }
  }

  // ============================================
  // INTEZER
  // ============================================

  async intezerAnalyze(req, res, next) {
    try {
      const { sha256 } = req.params;
      const result = await threatIntelService.intezerAnalyze(sha256);
      res.json(ApiResponse.success(result));
    } catch (error) {
      next(error);
    }
  }

  // ============================================
  // JOE SANDBOX
  // ============================================

  async joeSandboxSubmit(req, res, next) {
    try {
      const { fileData, fileName } = req.body;
      const buffer = Buffer.from(fileData, 'base64');
      const result = await threatIntelService.joeSandboxSubmit(buffer, fileName);
      res.json(ApiResponse.success(result, 'File submitted to Joe Sandbox'));
    } catch (error) {
      next(error);
    }
  }

  async joeSandboxReport(req, res, next) {
    try {
      const { webId } = req.params;
      const result = await threatIntelService.joeSandboxReport(webId);
      res.json(ApiResponse.success(result));
    } catch (error) {
      next(error);
    }
  }

  // ============================================
  // YARA SCANNING
  // ============================================

  async yaraScan(req, res, next) {
    try {
      const { data, dataType } = req.body;
      
      let scanData;
      if (dataType === 'base64') {
        scanData = Buffer.from(data, 'base64');
      } else if (dataType === 'strings') {
        scanData = Array.isArray(data) ? data.join('\n') : data;
      } else {
        scanData = data;
      }

      const result = yaraService.scan(scanData);
      res.json(ApiResponse.success(result, 'YARA scan completed'));
    } catch (error) {
      next(error);
    }
  }

  async yaraGetRules(req, res, next) {
    try {
      const rules = yaraService.getRules();
      res.json(ApiResponse.success(rules, 'YARA rules retrieved'));
    } catch (error) {
      next(error);
    }
  }

  async yaraAddRule(req, res, next) {
    try {
      const rule = req.body;
      const result = yaraService.addRule(rule);
      res.json(ApiResponse.success(result, 'Custom rule added'));
    } catch (error) {
      next(error);
    }
  }

  async yaraStats(req, res, next) {
    try {
      const stats = yaraService.getStats();
      res.json(ApiResponse.success(stats, 'YARA statistics'));
    } catch (error) {
      next(error);
    }
  }

  // ============================================
  // MITRE ATT&CK
  // ============================================

  async mitreGetTechnique(req, res, next) {
    try {
      const { techniqueId } = req.params;
      const technique = mitreService.getTechnique(techniqueId);
      
      if (!technique) {
        throw ApiError.notFound('Technique not found');
      }

      res.json(ApiResponse.success(technique));
    } catch (error) {
      next(error);
    }
  }

  async mitreGetTactics(req, res, next) {
    try {
      const tactics = mitreService.getAllTactics();
      res.json(ApiResponse.success(tactics, 'MITRE ATT&CK tactics'));
    } catch (error) {
      next(error);
    }
  }

  async mitreGetTechniques(req, res, next) {
    try {
      const { tacticId } = req.query;
      
      let techniques;
      if (tacticId) {
        techniques = mitreService.getTechniquesByTactic(tacticId);
      } else {
        techniques = mitreService.getAllTechniques();
      }

      res.json(ApiResponse.success(techniques, 'MITRE ATT&CK techniques'));
    } catch (error) {
      next(error);
    }
  }

  async mitreMapBehaviors(req, res, next) {
    try {
      const { behaviors } = req.body;
      
      if (!Array.isArray(behaviors)) {
        throw ApiError.badRequest('Behaviors must be an array');
      }

      const mappings = mitreService.mapBehaviors(behaviors);
      res.json(ApiResponse.success(mappings, 'Behaviors mapped to MITRE ATT&CK'));
    } catch (error) {
      next(error);
    }
  }

  async mitreGenerateReport(req, res, next) {
    try {
      const { techniqueIds } = req.body;
      
      if (!Array.isArray(techniqueIds)) {
        throw ApiError.badRequest('Technique IDs must be an array');
      }

      const report = mitreService.generateReport(techniqueIds);
      res.json(ApiResponse.success(report, 'MITRE ATT&CK report generated'));
    } catch (error) {
      next(error);
    }
  }

  async mitreSearch(req, res, next) {
    try {
      const { q } = req.query;
      
      if (!q || q.length < 2) {
        throw ApiError.badRequest('Search query too short');
      }

      const results = mitreService.searchTechniques(q);
      res.json(ApiResponse.success(results, `Found ${results.length} techniques`));
    } catch (error) {
      next(error);
    }
  }
}

module.exports = new ThreatIntelController();
