const MalwareSample = require('../models/Sample.model');
const { ApiResponse, ApiError } = require('../../../../../shared');
const malwareService = require('../services/malware.service');
const mlService = require('../services/ml.service');

class SampleController {
  async uploadSample(req, res, next) {
    try {
      const { fileName, fileSize, fileType, mimeType, fileData } = req.body;
      
      const buffer = Buffer.from(fileData, 'base64');
      const hashes = malwareService.calculateHashes(buffer);

      const sample = new MalwareSample({
        userId: req.user.id,
        sampleId: `SAMPLE-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        fileName,
        fileSize,
        fileType,
        mimeType,
        fileHashes: hashes,
        status: 'analyzing'
      });

      await sample.save();

      // Analyze asynchronously
      setImmediate(async () => {
        try {
          const staticAnalysis = await malwareService.performStaticAnalysis(buffer);
          sample.staticAnalysis = staticAnalysis;

          const mlResult = await mlService.analyzeSample({ 
            hashes, 
            staticAnalysis,
            fileType 
          });

          sample.mlPrediction = mlResult;
          sample.malwareType = mlResult.malwareType;
          sample.isMalicious = mlResult.isMalicious;
          sample.confidence = mlResult.confidence;
          sample.severity = malwareService.determineSeverity(sample);
          sample.status = 'completed';

          await sample.save();
        } catch (error) {
          sample.status = 'failed';
          await sample.save();
        }
      });

      res.status(201).json(ApiResponse.created(sample, 'Sample uploaded and analysis started'));
    } catch (error) {
      next(error);
    }
  }

  async getAllSamples(req, res, next) {
    try {
      const { page = 1, limit = 20, malwareType, severity, isMalicious } = req.query;
      const query = { userId: req.user.id };
      if (malwareType) query.malwareType = malwareType;
      if (severity) query.severity = severity;
      if (isMalicious !== undefined) query.isMalicious = isMalicious === 'true';

      const samples = await MalwareSample.find(query)
        .sort({ uploadedAt: -1 })
        .limit(limit * 1)
        .skip((page - 1) * limit)
        .select('-staticAnalysis.strings -dynamicAnalysis'); // Exclude large fields

      const total = await MalwareSample.countDocuments(query);

      res.json(ApiResponse.success({ samples, pagination: { total, page: parseInt(page), limit: parseInt(limit), pages: Math.ceil(total / limit) } }));
    } catch (error) {
      next(error);
    }
  }

  async getSampleById(req, res, next) {
    try {
      const sample = await MalwareSample.findById(req.params.id);
      if (!sample) throw ApiError.notFound('Sample not found');
      if (sample.userId.toString() !== req.user.id && req.user.role !== 'admin') throw ApiError.forbidden('Access denied');
      res.json(ApiResponse.success(sample));
    } catch (error) {
      next(error);
    }
  }

  async deleteSample(req, res, next) {
    try {
      const sample = await MalwareSample.findById(req.params.id);
      if (!sample) throw ApiError.notFound('Sample not found');
      if (sample.userId.toString() !== req.user.id && req.user.role !== 'admin') throw ApiError.forbidden('Access denied');
      await sample.deleteOne();
      res.json(ApiResponse.success(null, 'Sample deleted'));
    } catch (error) {
      next(error);
    }
  }

  async getStatistics(req, res, next) {
    try {
      const { startDate, endDate } = req.query;
      const timeRange = startDate && endDate ? { start: new Date(startDate), end: new Date(endDate) } : null;
      const stats = await malwareService.calculateStatistics(req.user.id, timeRange);
      res.json(ApiResponse.success(stats));
    } catch (error) {
      next(error);
    }
  }

  async scanHash(req, res, next) {
    try {
      const { hash } = req.body;
      const sample = await MalwareSample.findOne({
        $or: [
          { 'fileHashes.md5': hash },
          { 'fileHashes.sha1': hash },
          { 'fileHashes.sha256': hash }
        ]
      });

      if (sample) {
        return res.json(ApiResponse.success({ found: true, sample }));
      }

      const familyInfo = await mlService.detectFamily(hash);
      res.json(ApiResponse.success({ found: false, familyInfo }));
    } catch (error) {
      next(error);
    }
  }
}

module.exports = new SampleController();
