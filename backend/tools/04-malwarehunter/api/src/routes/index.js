const express = require('express');
const { body, query, param } = require('express-validator');
const { validate, authenticate } = require('../../../../shared');
const sampleController = require('../controllers/sample.controller');
const analysisController = require('../controllers/analysis.controller');
const reportController = require('../controllers/report.controller');

const router = express.Router();

// All routes require authentication
router.use(authenticate);

// Sample routes
router.post('/samples/upload',
  validate([
    body('fileName').isString().notEmpty(),
    body('fileSize').isInt({ min: 1 }),
    body('fileType').isString().notEmpty(),
    body('mimeType').isString().notEmpty(),
    body('fileData').isString().notEmpty()
  ]),
  sampleController.uploadSample
);

router.get('/samples',
  validate([
    query('page').optional().isInt({ min: 1 }),
    query('limit').optional().isInt({ min: 1, max: 100 }),
    query('malwareType').optional().isString(),
    query('severity').optional().isIn(['LOW', 'MEDIUM', 'HIGH', 'CRITICAL']),
    query('isMalicious').optional().isBoolean()
  ]),
  sampleController.getAllSamples
);

router.get('/samples/:id',
  validate([param('id').isMongoId()]),
  sampleController.getSampleById
);

router.delete('/samples/:id',
  validate([param('id').isMongoId()]),
  sampleController.deleteSample
);

router.get('/samples/statistics',
  validate([
    query('startDate').optional().isISO8601(),
    query('endDate').optional().isISO8601()
  ]),
  sampleController.getStatistics
);

router.post('/samples/scan-hash',
  validate([body('hash').isString().notEmpty()]),
  sampleController.scanHash
);

// Analysis routes
router.post('/analyses',
  validate([
    body('analysisType').isIn(['static', 'dynamic', 'behavioral', 'comprehensive', 'quick_scan']),
    body('timeRange').optional().isObject(),
    body('timeRange.start').optional().isISO8601(),
    body('timeRange.end').optional().isISO8601()
  ]),
  analysisController.createAnalysis
);

router.get('/analyses/:id',
  validate([param('id').isMongoId()]),
  analysisController.getAnalysisById
);

router.get('/analyses',
  validate([
    query('page').optional().isInt({ min: 1 }),
    query('limit').optional().isInt({ min: 1, max: 100 })
  ]),
  analysisController.getAllAnalyses
);

router.delete('/analyses/:id',
  validate([param('id').isMongoId()]),
  analysisController.deleteAnalysis
);

// Report routes
router.post('/reports/generate',
  validate([
    body('reportType').isIn(['daily', 'weekly', 'monthly', 'incident', 'forensic', 'executive']),
    body('title').optional().isString(),
    body('timeRange').optional().isObject(),
    body('timeRange.start').optional().isISO8601(),
    body('timeRange.end').optional().isISO8601(),
    body('format').optional().isIn(['pdf', 'html', 'json'])
  ]),
  reportController.generateReport
);

router.get('/reports/:id',
  validate([param('id').isMongoId()]),
  reportController.getReportById
);

router.get('/reports',
  validate([
    query('page').optional().isInt({ min: 1 }),
    query('limit').optional().isInt({ min: 1, max: 100 })
  ]),
  reportController.getAllReports
);

router.get('/reports/:id/export',
  validate([param('id').isMongoId()]),
  reportController.exportReport
);

router.delete('/reports/:id',
  validate([param('id').isMongoId()]),
  reportController.deleteReport
);

module.exports = router;
