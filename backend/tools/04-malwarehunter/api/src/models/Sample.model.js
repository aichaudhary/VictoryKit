const mongoose = require('mongoose');

const sampleSchema = new mongoose.Schema({
  userId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true,
    index: true
  },
  sampleId: {
    type: String,
    required: true,
    unique: true,
    index: true
  },
  fileName: {
    type: String,
    required: true
  },
  fileSize: {
    type: Number,
    required: true
  },
  fileType: String,
  mimeType: String,
  fileHashes: {
    md5: { type: String, index: true },
    sha1: { type: String, index: true },
    sha256: { type: String, index: true },
    ssdeep: String
  },
  malwareType: {
    type: String,
    enum: ['virus', 'trojan', 'ransomware', 'worm', 'rootkit', 'spyware', 'adware', 'backdoor', 'keylogger', 'botnet', 'unknown'],
    default: 'unknown'
  },
  severity: {
    type: String,
    enum: ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'],
    default: 'MEDIUM'
  },
  isMalicious: {
    type: Boolean,
    default: false
  },
  confidence: {
    type: Number,
    min: 0,
    max: 100,
    default: 0
  },
  staticAnalysis: {
    peInfo: mongoose.Schema.Types.Mixed,
    imports: [String],
    exports: [String],
    sections: [mongoose.Schema.Types.Mixed],
    strings: [String],
    entropy: Number,
    suspicious: [String]
  },
  dynamicAnalysis: {
    behavior: [String],
    networkActivity: [mongoose.Schema.Types.Mixed],
    fileActivity: [mongoose.Schema.Types.Mixed],
    registryActivity: [mongoose.Schema.Types.Mixed],
    processActivity: [mongoose.Schema.Types.Mixed]
  },
  signatures: [{
    name: String,
    description: String,
    severity: String,
    matched: Boolean
  }],
  avScans: [{
    engine: String,
    result: String,
    detected: Boolean,
    version: String,
    timestamp: Date
  }],
  mlPrediction: {
    malwareType: String,
    confidence: Number,
    familyName: String,
    model: String,
    features: mongoose.Schema.Types.Mixed,
    timestamp: Date
  },
  sandboxReport: {
    environment: String,
    executionTime: Number,
    screenshots: [String],
    networkCapture: String,
    memoryDump: String
  },
  status: {
    type: String,
    enum: ['pending', 'analyzing', 'completed', 'failed'],
    default: 'pending'
  },
  uploadedAt: {
    type: Date,
    default: Date.now
  },
  metadata: {
    type: Map,
    of: mongoose.Schema.Types.Mixed
  }
}, {
  timestamps: true,
  toJSON: { virtuals: true },
  toObject: { virtuals: true }
});

// Indexes
sampleSchema.index({ userId: 1, uploadedAt: -1 });
sampleSchema.index({ malwareType: 1 });
sampleSchema.index({ severity: 1, isMalicious: 1 });
sampleSchema.index({ status: 1 });

// Virtuals
sampleSchema.virtual('isCritical').get(function() {
  return this.severity === 'CRITICAL' && this.isMalicious;
});

sampleSchema.virtual('analysisComplete').get(function() {
  return this.status === 'completed';
});

module.exports = mongoose.model('MalwareSample', sampleSchema);
