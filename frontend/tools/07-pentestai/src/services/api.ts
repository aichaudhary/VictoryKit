// Re-export from main API service with Dashboard-compatible interface
import axios, { AxiosInstance, AxiosResponse } from 'axios';

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:4007';
const ML_URL = import.meta.env.VITE_ML_URL || 'http://localhost:8007';

class PentestAPI {
  private api: AxiosInstance;
  private mlApi: AxiosInstance;

  constructor() {
    this.api = axios.create({
      baseURL: `${API_URL}/api/v1/pentest`,
      timeout: 300000,
      headers: { 'Content-Type': 'application/json' },
    });

    this.mlApi = axios.create({
      baseURL: ML_URL,
      timeout: 120000,
      headers: { 'Content-Type': 'application/json' },
    });

    this.api.interceptors.request.use((config) => {
      const token = localStorage.getItem('auth_token');
      if (token) config.headers.Authorization = `Bearer ${token}`;
      return config;
    });
  }

  // Dashboard
  dashboard = {
    getStats: (): Promise<AxiosResponse> => this.api.get('/dashboard'),
    getAlerts: (): Promise<AxiosResponse> => this.api.get('/dashboard/alerts'),
    getTrends: (): Promise<AxiosResponse> => this.api.get('/dashboard/trends'),
  };

  // Targets
  targets = {
    list: (params?: { limit?: number; page?: number }): Promise<AxiosResponse> =>
      this.api.get('/targets', { params }),
    create: (target: any): Promise<AxiosResponse> =>
      this.api.post('/targets', target),
    get: (targetId: string): Promise<AxiosResponse> =>
      this.api.get(`/targets/${targetId}`),
    update: (targetId: string, data: any): Promise<AxiosResponse> =>
      this.api.put(`/targets/${targetId}`, data),
    delete: (targetId: string): Promise<AxiosResponse> =>
      this.api.delete(`/targets/${targetId}`),
  };

  // Scans
  scans = {
    list: (params?: { status?: string; limit?: number; page?: number }): Promise<AxiosResponse> =>
      this.api.get('/scans', { params }),
    create: (scan: {
      targetId: string;
      scanType: string;
      options?: any;
    }): Promise<AxiosResponse> => this.api.post('/scans', scan),
    get: (scanId: string): Promise<AxiosResponse> =>
      this.api.get(`/scans/${scanId}`),
    start: (scanId: string): Promise<AxiosResponse> =>
      this.api.post(`/scans/${scanId}/start`),
    stop: (scanId: string): Promise<AxiosResponse> =>
      this.api.post(`/scans/${scanId}/stop`),
    getResults: (scanId: string): Promise<AxiosResponse> =>
      this.api.get(`/scans/${scanId}/results`),
  };

  // Vulnerabilities
  vulnerabilities = {
    list: (params?: { severity?: string; status?: string; limit?: number }): Promise<AxiosResponse> =>
      this.api.get('/vulnerabilities', { params }),
    get: (vulnId: string): Promise<AxiosResponse> =>
      this.api.get(`/vulnerabilities/${vulnId}`),
    update: (vulnId: string, data: any): Promise<AxiosResponse> =>
      this.api.put(`/vulnerabilities/${vulnId}`, data),
    verify: (vulnId: string): Promise<AxiosResponse> =>
      this.api.post(`/vulnerabilities/${vulnId}/verify`),
    markFalsePositive: (vulnId: string, reason: string): Promise<AxiosResponse> =>
      this.api.post(`/vulnerabilities/${vulnId}/false-positive`, { reason }),
  };

  // Exploits
  exploits = {
    list: (params?: { category?: string; limit?: number }): Promise<AxiosResponse> =>
      this.api.get('/exploits', { params }),
    get: (exploitId: string): Promise<AxiosResponse> =>
      this.api.get(`/exploits/${exploitId}`),
    execute: (exploitId: string, targetId: string, options?: any): Promise<AxiosResponse> =>
      this.api.post(`/exploits/${exploitId}/execute`, { targetId, options }),
    getResults: (executionId: string): Promise<AxiosResponse> =>
      this.api.get(`/exploits/results/${executionId}`),
  };

  // Network
  network = {
    scan: (subnet: string, options?: any): Promise<AxiosResponse> =>
      this.api.post('/network/scan', { subnet, options }),
    getMap: (scanId: string): Promise<AxiosResponse> =>
      this.api.get(`/network/map/${scanId}`),
    getHosts: (scanId: string): Promise<AxiosResponse> =>
      this.api.get(`/network/hosts/${scanId}`),
    getServices: (hostId: string): Promise<AxiosResponse> =>
      this.api.get(`/network/services/${hostId}`),
  };

  // Analytics
  analytics = {
    getVulnCategories: (): Promise<AxiosResponse> =>
      this.api.get('/analytics/categories'),
    getTrends: (period?: string): Promise<AxiosResponse> =>
      this.api.get('/analytics/trends', { params: { period } }),
    getStats: (): Promise<AxiosResponse> =>
      this.api.get('/analytics/stats'),
    getCoverage: (): Promise<AxiosResponse> =>
      this.api.get('/analytics/coverage'),
  };

  // Reports
  reports = {
    generate: (reportData: {
      scanId: string;
      type: string;
      format?: string;
    }): Promise<AxiosResponse> => this.api.post('/reports', reportData),
    list: (params?: { type?: string; limit?: number }): Promise<AxiosResponse> =>
      this.api.get('/reports', { params }),
    get: (reportId: string): Promise<AxiosResponse> =>
      this.api.get(`/reports/${reportId}`),
    download: (reportId: string): Promise<AxiosResponse> =>
      this.api.get(`/reports/${reportId}/download`, { responseType: 'blob' }),
  };

  // ML Services
  ml = {
    predictVulnerability: (data: any): Promise<AxiosResponse> =>
      this.mlApi.post('/predict/vulnerability', data),
    suggestExploits: (vulnData: any): Promise<AxiosResponse> =>
      this.mlApi.post('/suggest/exploits', vulnData),
    analyzeTarget: (targetData: any): Promise<AxiosResponse> =>
      this.mlApi.post('/analyze/target', targetData),
  };
}

export const pentestAPI = new PentestAPI();
export default pentestAPI;
