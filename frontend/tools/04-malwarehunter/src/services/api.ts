import axios, { AxiosInstance, AxiosResponse } from 'axios';

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:4004';
const ML_URL = import.meta.env.VITE_ML_URL || 'http://localhost:8004';

class MalwareHunterAPI {
  private api: AxiosInstance;
  private mlApi: AxiosInstance;

  constructor() {
    this.api = axios.create({
      baseURL: `${API_URL}/api/v1/malware`,
      timeout: 60000,
      headers: { 'Content-Type': 'application/json' },
    });

    this.mlApi = axios.create({
      baseURL: ML_URL,
      timeout: 120000,
      headers: { 'Content-Type': 'application/json' },
    });

    this.api.interceptors.request.use((config) => {
      const token = localStorage.getItem('auth_token');
      if (token) config.headers.Authorization = `Bearer ${token}`;
      return config;
    });

    this.api.interceptors.response.use(
      (response) => response,
      (error) => {
        if (error.response?.status === 401) {
          localStorage.removeItem('auth_token');
          window.location.href = '/login';
        }
        return Promise.reject(error);
      }
    );
  }

  // Dashboard
  dashboard = {
    getStats: (): Promise<AxiosResponse> => this.api.get('/dashboard'),
    getAlerts: (): Promise<AxiosResponse> => this.api.get('/dashboard/alerts'),
    getTrends: (): Promise<AxiosResponse> => this.api.get('/dashboard/trends'),
  };

  // File Scanning
  scan = {
    uploadFile: (file: File, options?: { sandbox?: boolean }): Promise<AxiosResponse> => {
      const formData = new FormData();
      formData.append('file', file);
      if (options?.sandbox) formData.append('sandbox', 'true');
      return this.api.post('/scan/upload', formData, {
        headers: { 'Content-Type': 'multipart/form-data' },
      });
    },

    scanUrl: (url: string): Promise<AxiosResponse> => 
      this.api.post('/scan/url', { url }),

    scanHash: (hash: string): Promise<AxiosResponse> => 
      this.api.post('/scan/hash', { hash }),

    quickScan: (paths: string[]): Promise<AxiosResponse> => 
      this.api.post('/scan/quick', { paths }),

    fullScan: (): Promise<AxiosResponse> => 
      this.api.post('/scan/full'),

    customScan: (config: {
      paths: string[];
      depth?: number;
      excludes?: string[];
    }): Promise<AxiosResponse> => this.api.post('/scan/custom', config),

    getStatus: (scanId: string): Promise<AxiosResponse> => 
      this.api.get(`/scan/${scanId}/status`),

    cancelScan: (scanId: string): Promise<AxiosResponse> => 
      this.api.post(`/scan/${scanId}/cancel`),
  };

  // Detections
  detections = {
    list: (params?: { 
      status?: string; 
      severity?: string;
      malwareType?: string;
      limit?: number; 
      page?: number 
    }): Promise<AxiosResponse> => this.api.get('/detections', { params }),

    get: (detectionId: string): Promise<AxiosResponse> => 
      this.api.get(`/detections/${detectionId}`),

    quarantine: (detectionId: string): Promise<AxiosResponse> => 
      this.api.post(`/detections/${detectionId}/quarantine`),

    delete: (detectionId: string): Promise<AxiosResponse> => 
      this.api.delete(`/detections/${detectionId}`),

    restore: (detectionId: string): Promise<AxiosResponse> => 
      this.api.post(`/detections/${detectionId}/restore`),

    markFalsePositive: (detectionId: string, reason: string): Promise<AxiosResponse> => 
      this.api.post(`/detections/${detectionId}/false-positive`, { reason }),

    getReport: (detectionId: string): Promise<AxiosResponse> => 
      this.api.get(`/detections/${detectionId}/report`),
  };

  // Quarantine
  quarantine = {
    list: (params?: { limit?: number; page?: number }): Promise<AxiosResponse> => 
      this.api.get('/quarantine', { params }),

    get: (itemId: string): Promise<AxiosResponse> => 
      this.api.get(`/quarantine/${itemId}`),

    restore: (itemId: string): Promise<AxiosResponse> => 
      this.api.post(`/quarantine/${itemId}/restore`),

    delete: (itemId: string): Promise<AxiosResponse> => 
      this.api.delete(`/quarantine/${itemId}`),

    deleteAll: (): Promise<AxiosResponse> => 
      this.api.delete('/quarantine/all'),
  };

  // Sandbox Analysis
  sandbox = {
    submit: (file: File, options?: {
      timeout?: number;
      network?: boolean;
      os?: string;
    }): Promise<AxiosResponse> => {
      const formData = new FormData();
      formData.append('file', file);
      if (options) formData.append('options', JSON.stringify(options));
      return this.api.post('/sandbox/submit', formData, {
        headers: { 'Content-Type': 'multipart/form-data' },
      });
    },

    getAnalysis: (analysisId: string): Promise<AxiosResponse> => 
      this.api.get(`/sandbox/${analysisId}`),

    list: (params?: { status?: string; limit?: number }): Promise<AxiosResponse> => 
      this.api.get('/sandbox', { params }),

    getBehavior: (analysisId: string): Promise<AxiosResponse> => 
      this.api.get(`/sandbox/${analysisId}/behavior`),

    getNetworkActivity: (analysisId: string): Promise<AxiosResponse> => 
      this.api.get(`/sandbox/${analysisId}/network`),

    getFileActivity: (analysisId: string): Promise<AxiosResponse> => 
      this.api.get(`/sandbox/${analysisId}/files`),

    getRegistryActivity: (analysisId: string): Promise<AxiosResponse> => 
      this.api.get(`/sandbox/${analysisId}/registry`),

    getScreenshots: (analysisId: string): Promise<AxiosResponse> => 
      this.api.get(`/sandbox/${analysisId}/screenshots`),
  };

  // Real-time Protection
  protection = {
    getStatus: (): Promise<AxiosResponse> => this.api.get('/protection'),

    enable: (): Promise<AxiosResponse> => this.api.post('/protection/enable'),

    disable: (): Promise<AxiosResponse> => this.api.post('/protection/disable'),

    getSettings: (): Promise<AxiosResponse> => this.api.get('/protection/settings'),

    updateSettings: (settings: any): Promise<AxiosResponse> => 
      this.api.put('/protection/settings', settings),

    addExclusion: (exclusion: { type: string; value: string }): Promise<AxiosResponse> => 
      this.api.post('/protection/exclusions', exclusion),

    removeExclusion: (exclusionId: string): Promise<AxiosResponse> => 
      this.api.delete(`/protection/exclusions/${exclusionId}`),
  };

  // Analytics
  analytics = {
    getMalwareFamilies: (): Promise<AxiosResponse> => 
      this.api.get('/analytics/families'),

    getThreatTrends: (period?: string): Promise<AxiosResponse> => 
      this.api.get('/analytics/trends', { params: { period } }),

    getDetectionStats: (): Promise<AxiosResponse> => 
      this.api.get('/analytics/stats'),

    getTopThreats: (limit?: number): Promise<AxiosResponse> => 
      this.api.get('/analytics/top-threats', { params: { limit } }),
  };

  // Reports
  reports = {
    generate: (reportData: {
      type: string;
      period: { start: string; end: string };
      format?: string;
    }): Promise<AxiosResponse> => this.api.post('/reports', reportData),

    list: (params?: { type?: string; limit?: number }): Promise<AxiosResponse> => 
      this.api.get('/reports', { params }),

    get: (reportId: string): Promise<AxiosResponse> => 
      this.api.get(`/reports/${reportId}`),

    download: (reportId: string): Promise<AxiosResponse> => 
      this.api.get(`/reports/${reportId}/download`, { responseType: 'blob' }),
  };

  // ML Services
  ml = {
    classifyFile: (fileData: any): Promise<AxiosResponse> => 
      this.mlApi.post('/classify', fileData),

    predictMalware: (features: any): Promise<AxiosResponse> => 
      this.mlApi.post('/predict', features),

    analyzeStatic: (fileHash: string): Promise<AxiosResponse> => 
      this.mlApi.post('/analyze/static', { hash: fileHash }),

    analyzeDynamic: (behaviorData: any): Promise<AxiosResponse> => 
      this.mlApi.post('/analyze/dynamic', behaviorData),

    extractFeatures: (fileData: any): Promise<AxiosResponse> => 
      this.mlApi.post('/extract-features', fileData),

    getSimilarSamples: (hash: string): Promise<AxiosResponse> => 
      this.mlApi.get(`/similar/${hash}`),
  };
}

export const malwareHunterAPI = new MalwareHunterAPI();
export default malwareHunterAPI;
