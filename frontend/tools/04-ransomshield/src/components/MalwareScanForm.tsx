import React, { useState, useRef } from "react";
import {
  Upload,
  FileText,
  Shield,
  Zap,
  Search,
  Settings,
  ChevronDown,
  ChevronUp,
  Bug,
  Cpu,
  FileCode,
  Archive,
  File,
  X,
  Play,
  Square,
  HardDrive,
  Globe,
  Layers,
  CheckCircle2,
  AlertTriangle,
} from "lucide-react";

export interface ScanConfig {
  scanType: "file" | "url" | "hash" | "memory";
  files: File[];
  urlOrHash: string;
  scanDepth: "quick" | "standard" | "deep";
  enableHeuristics: boolean;
  enableBehavioral: boolean;
  enableSandbox: boolean;
  enableYara: boolean;
  autoQuarantine: boolean;
}

interface MalwareScanFormProps {
  onSubmit: (config: ScanConfig) => void;
  isLoading: boolean;
  onStop?: () => void;
}

const MalwareScanForm: React.FC<MalwareScanFormProps> = ({
  onSubmit,
  isLoading,
  onStop,
}) => {
  const [scanType, setScanType] = useState<ScanConfig["scanType"]>("file");
  const [files, setFiles] = useState<File[]>([]);
  const [urlOrHash, setUrlOrHash] = useState("");
  const [scanDepth, setScanDepth] =
    useState<ScanConfig["scanDepth"]>("standard");
  const [showAdvanced, setShowAdvanced] = useState(false);
  const [enableHeuristics, setEnableHeuristics] = useState(true);
  const [enableBehavioral, setEnableBehavioral] = useState(true);
  const [enableSandbox, setEnableSandbox] = useState(false);
  const [enableYara, setEnableYara] = useState(true);
  const [autoQuarantine, setAutoQuarantine] = useState(false);
  const [dragActive, setDragActive] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const handleDrag = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    if (e.type === "dragenter" || e.type === "dragover") {
      setDragActive(true);
    } else if (e.type === "dragleave") {
      setDragActive(false);
    }
  };

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setDragActive(false);
    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
      setFiles((prev) => [...prev, ...Array.from(e.dataTransfer.files)]);
    }
  };

  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files.length > 0) {
      setFiles((prev) => [...prev, ...Array.from(e.target.files!)]);
    }
  };

  const removeFile = (index: number) => {
    setFiles((prev) => prev.filter((_, i) => i !== index));
  };

  const getFileIcon = (fileName: string) => {
    const ext = fileName.split(".").pop()?.toLowerCase();
    switch (ext) {
      case "exe":
      case "msi":
        return <Bug className="w-4 h-4 text-red-400" />;
      case "dll":
      case "sys":
        return <Cpu className="w-4 h-4 text-orange-400" />;
      case "js":
      case "vbs":
      case "ps1":
        return <FileCode className="w-4 h-4 text-yellow-400" />;
      case "zip":
      case "rar":
      case "7z":
        return <Archive className="w-4 h-4 text-cyan-400" />;
      case "pdf":
      case "doc":
      case "docx":
        return <FileText className="w-4 h-4 text-blue-400" />;
      default:
        return <File className="w-4 h-4 text-gray-400" />;
    }
  };

  const formatFileSize = (bytes: number) => {
    if (bytes === 0) return "0 B";
    const k = 1024;
    const sizes = ["B", "KB", "MB", "GB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
  };

  const handleSubmit = () => {
    onSubmit({
      scanType,
      files,
      urlOrHash,
      scanDepth,
      enableHeuristics,
      enableBehavioral,
      enableSandbox,
      enableYara,
      autoQuarantine,
    });
  };

  const canSubmit =
    scanType === "file" ? files.length > 0 : urlOrHash.trim().length > 0;

  return (
    <div className="malware-card p-6">
      <div className="flex items-center gap-3 mb-6">
        <div className="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center">
          <Search className="w-5 h-5 text-purple-400" />
        </div>
        <div>
          <h3 className="text-lg font-bold text-white">Malware Scanner</h3>
          <p className="text-xs text-gray-500">AI-Powered Detection Engine</p>
        </div>
      </div>

      {/* Scan Type Tabs */}
      <div className="grid grid-cols-4 gap-2 mb-6">
        {[
          { id: "file", icon: Upload, label: "File" },
          { id: "url", icon: Globe, label: "URL" },
          { id: "hash", icon: FileCode, label: "Hash" },
          { id: "memory", icon: HardDrive, label: "Memory" },
        ].map((tab) => (
          <button
            key={tab.id}
            onClick={() => setScanType(tab.id as ScanConfig["scanType"])}
            className={`flex flex-col items-center gap-1 p-3 rounded-lg border transition-all ${
              scanType === tab.id
                ? "bg-purple-500/20 border-purple-500/50 text-purple-400"
                : "bg-slate-800/50 border-slate-700 text-gray-400 hover:border-purple-500/30"
            }`}
          >
            <tab.icon className="w-5 h-5" />
            <span className="text-xs font-medium">{tab.label}</span>
          </button>
        ))}
      </div>

      {/* File Upload Zone */}
      {scanType === "file" && (
        <div className="mb-6">
          <div
            onDragEnter={handleDrag}
            onDragLeave={handleDrag}
            onDragOver={handleDrag}
            onDrop={handleDrop}
            onClick={() => fileInputRef.current?.click()}
            className={`upload-zone cursor-pointer text-center ${
              dragActive ? "drag-active" : ""
            }`}
          >
            <input
              ref={fileInputRef}
              type="file"
              multiple
              onChange={handleFileSelect}
              className="hidden"
            />
            <Upload className="w-12 h-12 mx-auto mb-3 text-purple-400" />
            <p className="text-white font-medium mb-1">
              Drop files here or click to upload
            </p>
            <p className="text-xs text-gray-500">
              Supports executables, scripts, documents, archives
            </p>
          </div>

          {files.length > 0 && (
            <div className="mt-4 space-y-2 max-h-48 overflow-y-auto">
              {files.map((file, index) => (
                <div
                  key={index}
                  className="flex items-center gap-3 p-3 bg-slate-800/50 rounded-lg border border-slate-700"
                >
                  {getFileIcon(file.name)}
                  <div className="flex-1 min-w-0">
                    <p className="text-sm text-white truncate">{file.name}</p>
                    <p className="text-xs text-gray-500">
                      {formatFileSize(file.size)}
                    </p>
                  </div>
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      removeFile(index);
                    }}
                    className="p-1 hover:bg-red-500/20 rounded text-gray-400 hover:text-red-400 transition-colors"
                  >
                    <X className="w-4 h-4" />
                  </button>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* URL/Hash Input */}
      {(scanType === "url" || scanType === "hash") && (
        <div className="mb-6">
          <label className="block text-sm font-medium text-gray-400 mb-2">
            {scanType === "url"
              ? "Enter URL to Scan"
              : "Enter File Hash (MD5/SHA1/SHA256)"}
          </label>
          <input
            type="text"
            value={urlOrHash}
            onChange={(e) => setUrlOrHash(e.target.value)}
            placeholder={
              scanType === "url"
                ? "https://example.com/file.exe"
                : "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
            }
            className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition-colors font-mono text-sm"
          />
        </div>
      )}

      {/* Memory Scan */}
      {scanType === "memory" && (
        <div className="mb-6 p-4 bg-slate-800/50 rounded-lg border border-slate-700">
          <div className="flex items-center gap-3 mb-3">
            <HardDrive className="w-5 h-5 text-purple-400" />
            <span className="text-white font-medium">Memory Scan</span>
          </div>
          <p className="text-sm text-gray-400 mb-3">
            Scan system memory for active threats, rootkits, and fileless
            malware.
          </p>
          <div className="flex items-center gap-2 text-xs text-yellow-400">
            <AlertTriangle className="w-4 h-4" />
            <span>Requires elevated privileges</span>
          </div>
        </div>
      )}

      {/* Scan Depth */}
      <div className="mb-6">
        <label className="block text-sm font-medium text-gray-400 mb-3">
          Scan Depth
        </label>
        <div className="grid grid-cols-3 gap-2">
          {[
            { id: "quick", label: "Quick", desc: "~10 sec" },
            { id: "standard", label: "Standard", desc: "~30 sec" },
            { id: "deep", label: "Deep", desc: "~2 min" },
          ].map((depth) => (
            <button
              key={depth.id}
              onClick={() => setScanDepth(depth.id as ScanConfig["scanDepth"])}
              className={`p-3 rounded-lg border transition-all text-center ${
                scanDepth === depth.id
                  ? "bg-purple-500/20 border-purple-500/50"
                  : "bg-slate-800/50 border-slate-700 hover:border-purple-500/30"
              }`}
            >
              <span
                className={`block text-sm font-medium ${
                  scanDepth === depth.id ? "text-purple-400" : "text-white"
                }`}
              >
                {depth.label}
              </span>
              <span className="text-xs text-gray-500">{depth.desc}</span>
            </button>
          ))}
        </div>
      </div>

      {/* Advanced Options Toggle */}
      <button
        onClick={() => setShowAdvanced(!showAdvanced)}
        className="flex items-center gap-2 text-sm text-gray-400 hover:text-purple-400 mb-4 transition-colors"
      >
        <Settings className="w-4 h-4" />
        <span>Advanced Options</span>
        {showAdvanced ? (
          <ChevronUp className="w-4 h-4" />
        ) : (
          <ChevronDown className="w-4 h-4" />
        )}
      </button>

      {showAdvanced && (
        <div className="space-y-3 mb-6 p-4 bg-slate-800/30 rounded-lg border border-slate-700">
          {[
            {
              id: "heuristics",
              label: "Heuristic Analysis",
              desc: "Detect unknown threats",
              value: enableHeuristics,
              setter: setEnableHeuristics,
            },
            {
              id: "behavioral",
              label: "Behavioral Analysis",
              desc: "Monitor runtime behavior",
              value: enableBehavioral,
              setter: setEnableBehavioral,
            },
            {
              id: "sandbox",
              label: "Sandbox Execution",
              desc: "Safe detonation environment",
              value: enableSandbox,
              setter: setEnableSandbox,
            },
            {
              id: "yara",
              label: "YARA Rules",
              desc: "Custom signature matching",
              value: enableYara,
              setter: setEnableYara,
            },
            {
              id: "quarantine",
              label: "Auto-Quarantine",
              desc: "Isolate detected threats",
              value: autoQuarantine,
              setter: setAutoQuarantine,
            },
          ].map((option) => (
            <label
              key={option.id}
              className="flex items-center justify-between p-3 bg-slate-900/50 rounded-lg cursor-pointer hover:bg-slate-900 transition-colors"
            >
              <div>
                <span className="text-sm font-medium text-white">
                  {option.label}
                </span>
                <p className="text-xs text-gray-500">{option.desc}</p>
              </div>
              <div
                onClick={() => option.setter(!option.value)}
                className={`w-10 h-6 rounded-full transition-colors cursor-pointer ${
                  option.value ? "bg-purple-500" : "bg-slate-700"
                }`}
              >
                <div
                  className={`w-4 h-4 bg-white rounded-full mt-1 transition-transform ${
                    option.value ? "translate-x-5" : "translate-x-1"
                  }`}
                />
              </div>
            </label>
          ))}
        </div>
      )}

      {/* Submit Button */}
      {isLoading ? (
        <button
          onClick={onStop}
          className="w-full flex items-center justify-center gap-2 bg-red-500/20 border border-red-500/50 text-red-400 py-4 rounded-xl hover:bg-red-500/30 transition-all font-medium"
        >
          <Square className="w-5 h-5" />
          Stop Scan
        </button>
      ) : (
        <button
          onClick={handleSubmit}
          disabled={!canSubmit}
          className={`w-full flex items-center justify-center gap-2 py-4 rounded-xl font-medium transition-all ${
            canSubmit
              ? "bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:from-purple-600 hover:to-pink-600 shadow-lg shadow-purple-500/25"
              : "bg-slate-800 text-gray-500 cursor-not-allowed"
          }`}
        >
          <Zap className="w-5 h-5" />
          Start Malware Scan
        </button>
      )}

      {/* Quick Stats */}
      <div className="mt-4 grid grid-cols-2 gap-3">
        <div className="flex items-center gap-2 p-2 bg-slate-800/50 rounded-lg">
          <CheckCircle2 className="w-4 h-4 text-green-400" />
          <span className="text-xs text-gray-400">12.8M signatures</span>
        </div>
        <div className="flex items-center gap-2 p-2 bg-slate-800/50 rounded-lg">
          <Shield className="w-4 h-4 text-purple-400" />
          <span className="text-xs text-gray-400">Real-time protection</span>
        </div>
      </div>
    </div>
  );
};

export default MalwareScanForm;
